<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מחשבון השוואת מסלולי דיור מוגן</title>
  <link rel="stylesheet" href="index.css" />
</head>
<body>
  <div class="top-bar">
      <div class="top-bar-container">
          <div class="top-bar-settings" id="topBarSettings">
              <label for="maxYears">
                  <span class="desktop-text">מגבלת סימולציה (שנים)</span>
                  <span class="mobile-text">שנים</span>
              </label>
              <div class="spinner-control">
                  <button type="button" class="spinner-btn" data-step-dir="up" data-target="maxYears">+</button>
                  <input type="text" id="maxYears" value="15" inputmode="decimal"/>
                  <button type="button" class="spinner-btn" data-step-dir="down" data-target="maxYears">-</button>
              </div>
          </div>
          <div class="actions">
              <div class="tooltip-container">
                  <input type="file" id="importFile" accept=".json" style="display:none;">
                  <button id="importBtn" class="btn secondary icon-btn" aria-label="ייבוא נתונים">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                  </button>
                  <span class="tooltip-text-topbar">ייבוא נתונים</span>
              </div>
              <div class="tooltip-container">
                  <button id="exportBtn" class="btn secondary icon-btn" aria-label="ייצוא נתונים">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                  </button>
                  <span class="tooltip-text-topbar">ייצוא נתונים</span>
              </div>
              <button id="calculateBtn" class="btn">השווה מסלולים</button>
          </div>
      </div>
  </div>

  <div class="container">
    <h1>מחשבון השוואת מסלולי דיור מוגן</h1>
    <p class="subtitle">הכלי מאפשר להשוות תרחישים פיננסיים שונים למגורים בדיור מוגן. התחילו בהזנת הנתונים הכלליים, הגדירו את מסלולי התמחור שברצונכם לבחון, ולבסוף השוו את התוצאות כדי לקבל החלטה מושכלת.</p>

    <!-- Step 1: Common Inputs -->
    <div class="card" id="commonInputsCard">
      <h2>שלב 1: נתונים כלליים ונכס</h2>
      <h3>פרמטרים פיננסיים</h3>
      <div class="row">
        <div class="span-3"><label for="initCash">הון נזיל התחלתי (₪)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="initCash">+</button><input type="text" id="initCash" value="1500000" class="income" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="initCash">-</button></div></div>
        <div class="span-3"><label for="monthlyIncome">הכנסה חודשית קבועה (₪)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="monthlyIncome">+</button><input type="text" id="monthlyIncome" value="5500" class="income" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="monthlyIncome">-</button></div></div>
        <div class="span-3"><label for="monthlyLivingExpenses">הוצאות מחייה חודשיות (₪)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="monthlyLivingExpenses">+</button><input type="text" id="monthlyLivingExpenses" value="1500" class="expense" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="monthlyLivingExpenses">-</button></div></div>
        <div class="span-3">
            <label for="oneTimeCosts">
                <span class="tooltip-header">עלויות חד־פעמיות (₪)
                    <span class="tooltip-text">מכסה הוצאות גדולות ומיידיות הקשורות למעבר, שאינן הפיקדון או דמי הכניסה. למשל: הובלה, ריהוט, שיפוץ קל, או עמלות. סכום זה יופחת מההון הנזיל ההתחלתי שלך ביום הראשון של הסימולציה.</span>
                </span>
            </label>
            <div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="oneTimeCosts">+</button><input type="text" id="oneTimeCosts" value="0" class="expense" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="oneTimeCosts">-</button></div>
        </div>
      </div>
      <div class="row">
        <div class="span-6"><label for="annualReturn">תשואת ריבית שנתית על היתרה (%)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="annualReturn">+</button><input type="text" id="annualReturn" value="4.5" class="income" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="annualReturn">-</button></div></div>
        <div class="span-6">
            <label for="annualInflation">
                <span class="tooltip-header">קצב התייקרות שנתי (מדד) (%)
                    <span class="tooltip-text">שיעור האינפלציה השנתי הצפוי. משפיע על התייקרות דמי האחזקה, הוצאות המחייה, וההכנסה משכר דירה לאורך זמן, כדי לדמות את עליית יוקר המחיה.</span>
                </span>
            </label>
            <div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="annualInflation">+</button><input type="text" id="annualInflation" value="2" class="expense" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="annualInflation">-</button></div>
        </div>
      </div>
      
      <div class="hr"></div>
      <h3>מצב סיעודי</h3>
      <div class="row">
        <div class="span-12"><label class="inline-row"><input id="isNursing" type="checkbox"/> להפעיל תרחיש מצב סיעודי</label></div>
      </div>
      <div class="row" id="nursingFieldsRow" style="display: none;">
        <div class="span-4"><label for="monthsIndependent">חודשים בתפקוד מלא</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="monthsIndependent">+</button><input type="text" id="monthsIndependent" value="60" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="monthsIndependent">-</button></div></div>
        <div class="span-4"><label for="nursingAddon">תוספת חודשית במצב סיעודי (₪)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="nursingAddon">+</button><input type="text" id="nursingAddon" value="18000" class="expense" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="nursingAddon">-</button></div></div>
        <div class="span-4">
            <label for="nursingAllowance">
                <span class="tooltip-header">גמלת סיעוד לקיזוז (₪/חודש)
                    <span class="tooltip-text">סכום חודשי הצפוי להתקבל ממקור חיצוני (כגון ביטוח לאומי או פוליסה פרטית) למימון הטיפול הסיעודי. סכום זה מופחת מה'תוספת החודשית במצב סיעודי' כדי לחשב את ההוצאה נטו שלכם.</span>
                </span>
            </label>
            <div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="nursingAllowance">+</button><input type="text" id="nursingAllowance" value="0" class="income" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="nursingAllowance">-</button></div>
        </div>
      </div>

      <div class="hr"></div>
      <h3>תרחיש נכס</h3>
      <div class="row">
        <div class="span-4">
            <label for="assetScenarioSelect">בחר תרחיש עבור הדירה</label>
            <select id="assetScenarioSelect">
                <option value="sell">מכירת הדירה</option>
                <option value="rent" selected>השכרת הדירה</option>
                <option value="none">ללא שימוש בדירה</option>
            </select>
        </div>
      </div>
      <div id="sellBlock" style="display: none;">
        <div class="row">
          <div class="span-6"><label for="salePrice">מחיר מכירה (₪)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="salePrice">+</button><input type="text" id="salePrice" value="3000000" class="income" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="salePrice">-</button></div></div>
          <div class="span-6"><label for="saleCostsPct">עלויות עסקה (% מהמחיר)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="saleCostsPct">+</button><input type="text" id="saleCostsPct" value="3" class="expense" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="saleCostsPct">-</button></div></div>
        </div>
      </div>
      <div id="rentBlock">
        <div class="row">
          <div class="span-3"><label for="rentGross">שכ"ד חודשי ברוטו (₪)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="rentGross">+</button><input type="text" id="rentGross" value="7000" class="income" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="rentGross">-</button></div></div>
          <div class="span-3"><label for="rentTaxPct">מס על שכ"ד (%)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="rentTaxPct">+</button><input type="text" id="rentTaxPct" value="10" class="expense" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="rentTaxPct">-</button></div></div>
          <div class="span-3">
            <label for="vacancyPct">
                <span class="tooltip-header">חודשים פנויים בשנה (%)
                    <span class="tooltip-text">אחוז הזמן המוערך בשנה בו הנכס יעמוד ריק ולא יניב הכנסה, למשל בתקופות מעבר בין שוכרים. הנתון מפחית את ההכנסה השנתית משכירות כדי לשקף תחזית מציאותית יותר.</span>
                </span>
                 <span class="note" id="vacancyMonthsNote" style="display: block; font-weight: normal; line-height: 1.2; margin-top: 2px;"></span>
            </label>
            <div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="vacancyPct">+</button><input type="text" id="vacancyPct" value="8" class="expense" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="vacancyPct">-</button></div>
          </div>
          <div class="span-3"><label for="annualMaintenance">תחזוקה שנתית (₪)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="annualMaintenance">+</button><input type="text" id="annualMaintenance" value="6000" class="expense" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="annualMaintenance">-</button></div></div>
        </div>
      </div>
    </div>
    
    <!-- Step 2: Tracks Definition -->
    <div class="card" id="tracksCard">
        <div class="header-row">
            <h2>שלב 2: הגדרת מסלולים להשוואה</h2>
            <div class="tooltip-container">
                <button id="toggleAllTracksBtn" class="btn secondary icon-btn" aria-label="כווץ הכל">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 11 12 6 7 11"></polyline><polyline points="17 18 12 13 7 18"></polyline></svg>
                </button>
                <span class="tooltip-text-topbar" id="toggleAllTooltip">כווץ הכל</span>
            </div>
        </div>
        <div id="tracksContainer"></div>
        <button id="addTrackBtn" class="btn secondary" style="margin-top: 16px;">+ הוסף מסלול חדש</button>
    </div>

  </div>

  <!-- Results Modal -->
  <div id="resultsModal" class="modal-overlay">
      <div class="modal-content">
          <div class="modal-header">
              <h2>שלב 3: השוואת תוצאות</h2>
              <button id="closeModalBtn" class="modal-close" aria-label="סגור חלון">&times;</button>
          </div>

          <div id="sliderGroup">
              <label for="yearSlider" id="yearSliderLabel">הצג תוצאות לאחר:</label>
              <div class="slider-container">
                  <output for="yearSlider" id="sliderValueBubble"></output>
                  <input type="range" id="yearSlider" min="0.5" max="15" value="15" step="0.5">
                  <div id="sliderTicksContainer"></div>
              </div>
          </div>

          <div id="resultsTableContainer"></div>
      </div>
  </div>


  <script>
    /**
     * Senior Living Calculator
     * Optimized Version: Caches DOM Access, Batches Layout Updates, Uses Shared Formatters
     */
    const App = (function() {
        // --- Constants & Config ---
        const Constants = {
            ICONS: {
                collapse: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 11 12 6 7 11"></polyline><polyline points="17 18 12 13 7 18"></polyline></svg>`,
                expand: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="7 13 12 18 17 13"></polyline><polyline points="7 6 12 11 17 6"></polyline></svg>`
            },
            // Cached Formatter to avoid reinstantiating on every keystroke
            FMT: new Intl.NumberFormat('he-IL', { maximumFractionDigits: 0 }) 
        };

        // --- Utilities ---
        const Utils = {
            $: (id) => document.getElementById(id),
            
            fmt: (n) => n === null || isNaN(n) ? '—' : Constants.FMT.format(Math.round(n)),
            
            unformat: (val) => +(val || '0').toString().replace(/,/g, ''),
            
            formatNumber: (v) => {
                if (v === '' || v === null || v === undefined) return '';
                const clean = v.toString().replace(/[^0-9.]/g, '');
                if (clean === '') return '';
                const parts = clean.split('.');
                // Use cached formatter
                const integerPart = Constants.FMT.format(Number(parts[0]));
                return parts.length > 1 ? `${integerPart}.${parts[1]}` : integerPart;
            },

            debounce: (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            escapeHtml: (unsafe) => {
                return (unsafe || '')
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        };

        // --- Simulation Engine (Pure Logic) ---
        const Calculator = {
            simulate: (p) => {
                // Initialize cash flow based on scenario
                let cash = p.initCash;
                if (p.scenario === 'sell') cash += Math.max(0, p.salePrice * (1 - p.saleCostsPct));
                
                let depositBook = 0;
                let entranceFeeBook = 0;

                // Deduct initial costs
                if (p.pricingMode === 'deposit' && p.depositAmount > 0) {
                    cash -= p.depositAmount;
                    depositBook = p.depositAmount;
                }
                if (p.pricingMode === 'entrance_fee' && p.entranceFeeAmount > 0) {
                    cash -= p.entranceFeeAmount;
                    entranceFeeBook = p.entranceFeeAmount;
                }
                cash -= p.oneTimeCosts;

                const monthlyLog = [];

                // Immediate Insolvency Check
                if (cash < 0) {
                     return { 
                         summary: { 
                             totalMonths: 0, independentMonths: 0, nursingMonths: 0, 
                             refundEnd: p.pricingMode === 'deposit' ? p.depositAmount : p.entranceFeeAmount, 
                             finalCash: 0, trackId: p.id, trackName: p.trackName, 
                             maxedOut: false, pricingMode: p.pricingMode 
                        }, 
                        monthlyLog 
                    };
                }

                // Constants for calculation
                const monthlyReturn = Math.pow(1 + p.annualReturn, 1/12) - 1;
                const monthlyInfl = Math.pow(1 + p.annualInflation, 1/12) - 1;
                const maxMonths = p.maxYears > 0 ? p.maxYears * 12 : 50 * 12;

                // Pre-calculate constants to avoid repeated logic in loop
                const isDeposit = p.pricingMode === 'deposit';
                const isEntrance = p.pricingMode === 'entrance_fee';
                
                // Depreciation config
                const depositFloor = isDeposit ? (p.depositAmount || 0) * (p.depositRefundPct || 0) : 0;
                const depositMonthlyDepreciation = isDeposit ? (p.depositAmount || 0) * ((p.depositDepreciationPct || 0) / 12) : 0;
                const entranceFeeMonthlyDep = isEntrance ? p.entranceFeeAmount * (p.entranceFeeDepreciationRateMonthly || 0) : 0;
                const entranceFeeMaxMonths = isEntrance ? p.entranceFeeDepreciationYears * 12 : 0;

                // Rent constants
                const maintenanceMonthly = p.annualMaintenance / 12;
                const rentNetFactor = (1 - p.rentTaxPct) * (1 - p.vacancyPct);

                // Loop Vars
                let t = 0, independentMonths = 0, nursingMonths = 0, lastPositiveCash = cash;
                
                while (t < maxMonths) {
                    // Optimized Inflation pow
                    const inflationFactor = Math.pow(1 + monthlyInfl, t);
                    
                    // Cash Return
                    cash *= (1 + monthlyReturn);

                    // Expenses
                    let base;
                    if (isDeposit) base = p.baseWithDeposit;
                    else if (isEntrance) base = p.baseWithEntranceFee;
                    else base = p.baseNoDeposit;
                    
                    const currentBaseCost = base * inflationFactor;
                    const currentNursingCost = (p.isNursing && t >= p.monthsIndependent) 
                        ? (Math.max(0, p.nursingAddon - p.nursingAllowance) * inflationFactor) 
                        : 0;
                        
                    const providerMonthlyCost = currentBaseCost + currentNursingCost;
                    const totalMonthlyCost = providerMonthlyCost + (p.monthlyLivingExpenses * inflationFactor);

                    // Income
                    let rentIncome = 0;
                    if (p.scenario === 'rent') {
                        const gross = p.rentGross * inflationFactor;
                        rentIncome = Math.max(0, (gross * rentNetFactor) - maintenanceMonthly);
                    }
                    const income = p.monthlyIncome + rentIncome;

                    // Net Flow
                    cash += (income - totalMonthlyCost);
                    
                    // Bookkeeping: Depreciation
                    let depreciationThisMonth = 0;
                    
                    if (isDeposit && depositBook > depositFloor) {
                        const maxDeductible = Math.max(0, depositBook - depositFloor);
                        const actualDeduction = Math.min(depositMonthlyDepreciation, maxDeductible);
                        depreciationThisMonth = actualDeduction;
                        depositBook -= actualDeduction;
                    }
                    
                    if (isEntrance && entranceFeeBook > 0 && t < entranceFeeMaxMonths) {
                        const actualDepreciation = Math.min(entranceFeeBook, entranceFeeMonthlyDep);
                        depreciationThisMonth = actualDepreciation;
                        entranceFeeBook = Math.max(0, entranceFeeBook - entranceFeeMonthlyDep);
                    }
                    
                    const providerEconomicCost = providerMonthlyCost + depreciationThisMonth;

                    if (cash < 0) break;
                    
                    if (p.isNursing && t >= p.monthsIndependent) nursingMonths++; else independentMonths++;
                    lastPositiveCash = cash;
                    
                    const refundCurrent = isDeposit ? depositBook : (isEntrance ? entranceFeeBook : 0);
                    
                    monthlyLog.push({ 
                        month: t + 1, 
                        totalCost: totalMonthlyCost, 
                        providerCost: providerMonthlyCost, 
                        providerEconomicCost, 
                        cash: lastPositiveCash, 
                        refund: refundCurrent, 
                        independentMonths, 
                        nursingMonths 
                    });
                    
                    t++;
                }

                const refundEnd = isDeposit ? depositBook : (isEntrance ? entranceFeeBook : 0);

                return { 
                    summary: { 
                        totalMonths: t, independentMonths, nursingMonths, refundEnd, 
                        finalCash: lastPositiveCash, trackId: p.id, trackName: p.trackName, 
                        maxedOut: t >= maxMonths, pricingMode: p.pricingMode 
                    }, 
                    monthlyLog 
                };
            }
        };

        // --- State Management ---
        const State = {
            tracks: [],
            simulationResults: [],
            
            addTrack: () => {
                const newTrack = {
                    id: Date.now(),
                    company: `מסלול ${State.tracks.length + 1}`,
                    room: '',
                    pricingMode: 'deposit'
                };
                State.tracks.push(newTrack);
                return newTrack;
            },
            
            removeTrack: (id) => {
                State.tracks = State.tracks.filter(t => t.id != id);
            },
            
            clearTracks: () => {
                State.tracks = [];
            }
        };

        // --- Drag & Drop Manager ---
        const DragManager = {
            draggedItem: null,
            placeholder: null,
            ghost: null,
            startY: 0,
            initialTop: 0,
            
            init: () => {
                const container = Utils.$('tracksContainer');
                
                // Unified Mouse and Touch Events
                container.addEventListener('mousedown', DragManager.handleStart);
                container.addEventListener('touchstart', DragManager.handleStart, { passive: false });
                
                document.addEventListener('mousemove', DragManager.handleMove);
                document.addEventListener('touchmove', DragManager.handleMove, { passive: false });
                
                document.addEventListener('mouseup', DragManager.handleEnd);
                document.addEventListener('touchend', DragManager.handleEnd);
            },
            
            handleStart: (e) => {
                const handle = e.target.closest('.drag-handle');
                if (!handle) return;
                
                e.preventDefault(); // Prevent text selection/scroll
                
                const card = handle.closest('.track-card');
                if (!card) return;
                
                DragManager.draggedItem = card;
                
                // Get coordinates
                const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                const rect = card.getBoundingClientRect();
                
                DragManager.startY = clientY;
                DragManager.initialTop = rect.top;
                
                // Create Placeholder
                DragManager.placeholder = document.createElement('div');
                DragManager.placeholder.className = 'drag-placeholder';
                DragManager.placeholder.style.height = `${rect.height}px`;
                card.parentNode.insertBefore(DragManager.placeholder, card);
                
                // Create Ghost
                DragManager.ghost = card.cloneNode(true);
                DragManager.ghost.classList.add('drag-ghost');
                DragManager.ghost.style.width = `${rect.width}px`;
                DragManager.ghost.style.height = `${rect.height}px`;
                DragManager.ghost.style.top = `${rect.top}px`;
                // Adjust left for RTL/LTR body
                const bodyRect = document.body.getBoundingClientRect();
                DragManager.ghost.style.left = `${rect.left}px`;
                
                // Preserve values for inputs in ghost
                const originalInputs = card.querySelectorAll('input, select');
                const ghostInputs = DragManager.ghost.querySelectorAll('input, select');
                originalInputs.forEach((inp, i) => {
                     if (inp.type === 'checkbox') ghostInputs[i].checked = inp.checked;
                     else ghostInputs[i].value = inp.value;
                });
                
                document.body.appendChild(DragManager.ghost);
                
                // Hide Original
                card.classList.add('is-dragging');
            },
            
            handleMove: (e) => {
                if (!DragManager.draggedItem) return;
                e.preventDefault(); // Prevent scrolling
                
                const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                const deltaY = clientY - DragManager.startY;
                
                // Move Ghost
                if (DragManager.ghost) {
                    DragManager.ghost.style.top = `${DragManager.initialTop + deltaY}px`;
                }
                
                // DOM swapping logic
                // Find element below cursor (offset by ghost height/2 for center)
                // Use built-in logic: compare clientY to other cards
                const siblings = [...Utils.$('tracksContainer').querySelectorAll('.track-card:not(.is-dragging)')];
                
                const nextSibling = siblings.find(sibling => {
                    const box = sibling.getBoundingClientRect();
                    return clientY < box.top + box.height / 2;
                });
                
                if (nextSibling) {
                    Utils.$('tracksContainer').insertBefore(DragManager.placeholder, nextSibling);
                } else {
                    Utils.$('tracksContainer').appendChild(DragManager.placeholder);
                }
            },
            
            handleEnd: (e) => {
                if (!DragManager.draggedItem) return;
                
                // Move original to placeholder position
                Utils.$('tracksContainer').insertBefore(DragManager.draggedItem, DragManager.placeholder);
                
                // Cleanup
                DragManager.draggedItem.classList.remove('is-dragging');
                if (DragManager.ghost) DragManager.ghost.remove();
                if (DragManager.placeholder) DragManager.placeholder.remove();
                
                DragManager.draggedItem = null;
                DragManager.ghost = null;
                DragManager.placeholder = null;
                
                // Reorder State
                const newOrderIds = Array.from(document.querySelectorAll('.track-card')).map(el => el.dataset.trackId);
                State.tracks.sort((a, b) => newOrderIds.indexOf(String(a.id)) - newOrderIds.indexOf(String(b.id)));
            }
        };

        // --- UI Manager ---
        const UI = {
            // Split reading inputs to optimize batch updates
            readCommonInputs: () => {
                 const getVal = (id) => {
                    const el = Utils.$(id);
                    return el ? Utils.unformat(el.value) : 0;
                };

                return {
                    isNursing: Utils.$('isNursing').checked,
                    initCash: getVal('initCash'),
                    monthlyIncome: getVal('monthlyIncome'),
                    monthlyLivingExpenses: getVal('monthlyLivingExpenses'),
                    oneTimeCosts: getVal('oneTimeCosts'),
                    annualReturn: getVal('annualReturn') / 100,
                    annualInflation: getVal('annualInflation') / 100,
                    maxYears: getVal('maxYears'),
                    monthsIndependent: getVal('monthsIndependent'),
                    nursingAddon: getVal('nursingAddon'),
                    nursingAllowance: getVal('nursingAllowance'),
                    scenario: Utils.$('assetScenarioSelect').value,
                    salePrice: getVal('salePrice'),
                    saleCostsPct: getVal('saleCostsPct') / 100,
                    rentGross: getVal('rentGross'),
                    rentTaxPct: getVal('rentTaxPct') / 100,
                    vacancyPct: getVal('vacancyPct') / 100,
                    annualMaintenance: getVal('annualMaintenance'),
                };
            },

            readTrackInputs: (trackId) => {
                const pMode = Utils.$(`pricingMode_${trackId}`).value;
                const company = Utils.$(`trackCompany_${trackId}`).value;
                const room = Utils.$(`trackRoom_${trackId}`).value;
                // Construct trackName for simulation logic compatibility
                const trackName = `${company}${room ? ' - ' + room : ''}`;

                // Helper for safe fetching
                const getVal = (id) => {
                    const el = Utils.$(id);
                    return el ? Utils.unformat(el.value) : 0;
                };

                const depPctVal = pMode === 'deposit' ? getVal(`depositDepreciationPct_${trackId}`) : 0;
                const depYearsVal = pMode === 'deposit' ? getVal(`depositDepreciationYears_${trackId}`) : 0;

                return {
                    id: trackId,
                    trackName: trackName,
                    company: company,
                    room: room,
                    pricingMode: pMode,
                    baseWithDeposit: pMode === 'deposit' ? getVal(`baseWithDeposit_${trackId}`) : 0,
                    baseWithEntranceFee: pMode === 'entrance_fee' ? getVal(`baseWithEntranceFee_${trackId}`) : 0,
                    baseNoDeposit: pMode === 'none' ? getVal(`baseNoDeposit_${trackId}`) : 0,
                    depositAmount: pMode === 'deposit' ? getVal(`depositAmount_${trackId}`) : 0,
                    depositDepreciationPct: depPctVal / 100,
                    depositDepreciationYears: depYearsVal,
                    depositRefundPct: pMode === 'deposit' ? Math.max(0, (100 - (depYearsVal * depPctVal)) / 100) : 0,
                    entranceFeeAmount: pMode === 'entrance_fee' ? getVal(`entranceFeeAmount_${trackId}`) : 0,
                    entranceFeeDepreciationRateMonthly: pMode === 'entrance_fee' ? (parseFloat(Utils.$(`entranceFeeDepreciationRateMonthly_${trackId}`)?.value || 0) / 100) : 0,
                    entranceFeeDepreciationYears: pMode === 'entrance_fee' ? getVal(`entranceFeeDepreciationYears_${trackId}`) : 0,
                };
            },

            readAllInputsForTrack: (trackId) => {
                // Wrapper for single track reads (less efficient but convenient)
                return { ...UI.readCommonInputs(), ...UI.readTrackInputs(trackId) };
            },

            // -- Rendering Components --
            Templates: {
                spinner: (id, val, cls = '', attrs = '') => `
                    <div class="spinner-control">
                        <button type="button" class="spinner-btn" data-step-dir="up" data-target="${id}">+</button>
                        <input type="text" id="${id}" value="${val}" class="${cls}" inputmode="decimal" ${attrs}/>
                        <button type="button" class="spinner-btn" data-step-dir="down" data-target="${id}">-</button>
                    </div>`,
                
                depositModeInputs: (id) => `
                    <div class="row">
                        <div class="span-2">
                            <label for="baseWithDeposit_${id}">דמי אחזקה (₪)</label>
                            ${UI.Templates.spinner(`baseWithDeposit_${id}`, '9000', 'expense', `data-track-id="${id}" data-base-value="9000"`)}
                        </div>
                        <div class="span-2">
                            <label for="reducedDepositAmount_${id}" class="tooltip-header">פקדון מופחת (₪)<span class="tooltip-text">סכום ההפחתה מהפיקדון. כל 50,000₪ הפחתה מהפיקדון מוסיפים 500₪ לדמי האחזקה החודשיים.</span></label>
                            <div class="spinner-control">
                                <button type="button" class="spinner-btn stepper-btn" data-step-dir="up" data-track-id="${id}">+</button>
                                <input type="text" id="reducedDepositAmount_${id}" data-track-id="${id}" value="0" class="expense" inputmode="decimal">
                                <button type="button" class="spinner-btn stepper-btn" data-step-dir="down" data-track-id="${id}">-</button>
                            </div>
                        </div>
                        <div class="span-4">
                            <label for="depositAmount_${id}">סכום פיקדון (₪)</label>
                            ${UI.Templates.spinner(`depositAmount_${id}`, '1000000', 'income', `data-track-id="${id}" data-base-value="1000000"`)}
                        </div>
                        <div class="span-2"><label for="depositDepreciationPct_${id}">פחת פיקדון שנתי (%)</label>${UI.Templates.spinner(`depositDepreciationPct_${id}`, '3', 'expense')}</div>
                        <div class="span-2">
                            <label for="depositDepreciationYears_${id}" class="tooltip-header">
                                תקופת שחיקה (שנים)
                                <span class="tooltip-text">תקופת השחיקה המקסימלית של הפיקדון. לאחר תקופה זו, גביית הפחת נפסקת ויתרת הפיקדון נשמרת.</span>
                                <span class="note" id="refundPctNote_${id}" style="display: block; font-weight: normal; line-height: 1.2; margin-top: 2px;"></span>
                            </label>
                            ${UI.Templates.spinner(`depositDepreciationYears_${id}`, '12', 'income')}
                        </div>
                    </div>`,

                entranceModeInputs: (id) => `
                    <div class="row">
                        <div class="span-3"><label for="baseWithEntranceFee_${id}">דמי אחזקה (₪)</label>${UI.Templates.spinner(`baseWithEntranceFee_${id}`, '9500', 'expense')}</div>
                        <div class="span-3"><label for="entranceFeeAmount_${id}">סכום דמי כניסה (₪)</label>${UI.Templates.spinner(`entranceFeeAmount_${id}`, '450000', 'income')}</div>
                        <div class="span-3"><label for="entranceFeeDepreciationYears_${id}">משך הפחת (שנים)</label>${UI.Templates.spinner(`entranceFeeDepreciationYears_${id}`, '5', 'expense')}</div>
                        <div class="span-3"><label for="entranceFeeDepreciationRateMonthly_${id}">פחת חודשי (מחושב)</label><input type="text" id="entranceFeeDepreciationRateMonthly_${id}" value="" class="expense" inputmode="decimal" readonly style="background-color: var(--bg); cursor: not-allowed;"></div>
                    </div>`,
                
                noneModeInputs: (id) => `
                     <div class="row"><div class="span-3"><label for="baseNoDeposit_${id}">דמי אחזקה (₪)</label>${UI.Templates.spinner(`baseNoDeposit_${id}`, '14000', 'expense')}</div></div>`
            },

            renderTrackCard: (track) => {
                const trackId = track.id;
                const card = document.createElement('div');
                card.className = 'track-card';
                card.dataset.trackId = trackId;
                
                // Safe values
                // Support legacy 'name' property if company not set
                const safeCompany = Utils.escapeHtml(track.company || track.name || '');
                const safeRoom = Utils.escapeHtml(track.room || '');
                const isSelected = (val) => track.pricingMode === val ? 'selected' : '';

                card.innerHTML = `
                    <div class="drag-handle" aria-label="גרור לסידור מחדש">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>
                    </div>
                    <button class="remove-track-btn" data-remove-track-id="${trackId}" aria-label="הסר מסלול">&times;</button>
                    <button class="toggle-track-btn" data-toggle-track-id="${trackId}" aria-label="מזער/הרחב">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                    </button>
                    <div class="track-header">
                        <div class="form-group full-width-mobile"><label for="trackCompany_${trackId}">שם חברה וכתובת</label><input type="text" id="trackCompany_${trackId}" value="${safeCompany}" placeholder="לדוגמה: אחוזת בית, רעננה"></div>
                        <div class="form-group full-width-mobile"><label for="trackRoom_${trackId}">סוג חדר וגודל</label><input type="text" id="trackRoom_${trackId}" value="${safeRoom}" placeholder="לדוגמה: 2 חדרים, 60 מ&quot;ר"></div>
                        <div class="form-group"><label for="pricingMode_${trackId}">סוג המסלול</label>
                            <select id="pricingMode_${trackId}">
                                <option value="deposit" ${isSelected('deposit')}>עם פיקדון</option>
                                <option value="entrance_fee" ${isSelected('entrance_fee')}>דמי כניסה</option>
                                <option value="none" ${isSelected('none')}>ללא</option>
                            </select>
                        </div>
                    </div>
                    <div class="track-body"></div>
                    <div class="track-preview" id="trackPreview_${trackId}"></div>
                    <div class="track-collapsed-view" id="trackCollapsed_${trackId}"></div>`;

                Utils.$('tracksContainer').appendChild(card);
                UI.updateTrackBody(trackId);
            },

            updateTrackBody: (trackId) => {
                const card = document.querySelector(`.track-card[data-track-id='${trackId}']`);
                const body = card.querySelector('.track-body');
                const mode = card.querySelector(`#pricingMode_${trackId}`).value;

                let html = '';
                if (mode === 'deposit') html = UI.Templates.depositModeInputs(trackId);
                else if (mode === 'entrance_fee') html = UI.Templates.entranceModeInputs(trackId);
                else html = UI.Templates.noneModeInputs(trackId);
                
                body.innerHTML = html;
                UI.setupNumberFormatting(body);
                
                if (mode === 'deposit') UI.updateRefundPctNote(trackId);
                if (mode === 'entrance_fee') UI.updateCalculatedEntranceFeeRate(trackId);
                UI.updateTrackPreview(trackId);
            },

            // Pure HTML generator to separate logic from DOM updates
            generatePreviewHTML: (result, params) => {
                const log = result.monthlyLog;
                
                if (!log || log.length === 0) {
                    return {
                        preview: '',
                        collapsed: `
                        <div class="collapsed-title">${Utils.escapeHtml(params.trackName) || 'מסלול ללא שם'}</div>
                        <div class="collapsed-stats" style="justify-content: center; opacity: 0.5;">נתונים חסרים</div>`
                    };
                }
                
                const summary = result.summary;
                const totalBalance = summary.finalCash + summary.refundEnd;
                
                // Calculate aggregated values
                const totalProviderCash = log.reduce((sum, item) => sum + (item.providerCost || 0), 0);
                const totalProviderEconomic = log.reduce((sum, item) => sum + (item.providerEconomicCost || 0), 0);
                const depreciation = totalProviderEconomic - totalProviderCash;

                // Label Logic
                let depLabel = `(ל-${params.maxYears} שנים)`;
                if (params.pricingMode === 'deposit') depLabel = `(ל-${params.depositDepreciationYears} שנים)`;
                else if (params.pricingMode === 'entrance_fee') depLabel = `(ל-${params.entranceFeeDepreciationYears} שנים)`;

                // Tooltip Texts
                const refundTooltip = params.pricingMode === 'entrance_fee'
                    ? 'יתרת דמי הכניסה שנותרה להחזר לאחר ניכוי הפחת המוגדר בחוזה.'
                    : 'סכום הפיקדון שנותר להחזר לאחר ניכוי הפחת השנתי המצטבר.';
                
                const finalCashTooltip = 'יתרת ההון הנזיל בבנק בסיום התקופה. החישוב: הון התחלתי + סך הכנסות (פנסיה, ריבית, שכירות) פחות סך הוצאות (דמי אחזקה, מחייה) לאורך השנים.';

                let refundLabel = params.pricingMode === 'entrance_fee' ? 'יתרת דמי כניסה' : 'יתרת הפיקדון';
                let refundHtml = params.pricingMode !== 'none' ? `
                    <div class="preview-item">
                        <span class="preview-label tooltip-header">${refundLabel} (סוף תקופה)<span class="tooltip-text">${refundTooltip}</span></span>
                        <span class="preview-value">${Utils.fmt(summary.refundEnd)} ₪</span>
                    </div>` : '';

                let insolvencyHtml = '';
                if (!summary.maxedOut) {
                     const years = Math.floor(summary.totalMonths / 12);
                     const months = summary.totalMonths % 12;
                     insolvencyHtml = `
                    <div class="preview-item insolvency-alert">
                        <span class="preview-label" style="color: var(--danger);">חדלות פירעון</span>
                        <span class="preview-value" style="color: var(--danger); direction: rtl;">${years} שנים ו-${months} חודשים</span>
                    </div>`;
                }

                const previewHtml = `
                    <div class="preview-item"><span class="preview-label">צפי אחזקה (ל-${params.maxYears} שנים)</span><span class="preview-value">${Utils.fmt(totalProviderCash)} ₪</span></div>
                    <div class="preview-item"><span class="preview-label">צפי שחיקה ${depLabel}</span><span class="preview-value">${Utils.fmt(depreciation)} ₪</span></div>
                    ${refundHtml}
                    <div class="preview-item"><span class="preview-label tooltip-header">יתרת החשבון (סוף תקופה)<span class="tooltip-text">${finalCashTooltip}</span></span><span class="preview-value">${Utils.fmt(summary.finalCash)} ₪</span></div>
                    <div class="preview-item"><span class="preview-label">סה"כ יתרה (הון + החזר)</span><span class="preview-value ok" style="font-weight: 800;">${Utils.fmt(totalBalance)} ₪</span></div>
                    <div class="preview-end-group">${insolvencyHtml}</div>`;

                const modeLabels = { 'deposit': 'מסלול פיקדון', 'entrance_fee': 'דמי כניסה', 'none': 'ללא פיקדון' };
                const typeLabel = modeLabels[params.pricingMode] || '';

                const collapsedHtml = `
                        <div class="collapsed-title">
                            ${Utils.escapeHtml(params.trackName) || 'מסלול ללא שם'}
                            <span style="font-weight:normal; opacity:0.7; font-size:0.9em; margin-right:8px;">• ${typeLabel}</span>
                        </div>
                        <div class="collapsed-stats">
                            <div class="collapsed-stat-item" title="צפי אחזקה"><span class="collapsed-stat-label">אחזקה</span><span class="collapsed-stat-value">${Utils.fmt(totalProviderCash)}</span></div>
                            <div class="collapsed-stat-item" title="צפי שחיקה"><span class="collapsed-stat-label">שחיקה</span><span class="collapsed-stat-value">${Utils.fmt(depreciation)}</span></div>
                            ${params.pricingMode !== 'none' ? `<div class="collapsed-stat-item" title="${refundLabel}"><span class="collapsed-stat-label">החזר</span><span class="collapsed-stat-value">${Utils.fmt(summary.refundEnd)}</span></div>` : ''}
                            <div class="collapsed-stat-item" title="יתרה לסיום"><span class="collapsed-stat-label">יתרה</span><span class="collapsed-stat-value">${Utils.fmt(summary.finalCash)}</span></div>
                            <div class="collapsed-stat-item" title="סה&quot;כ יתרה"><span class="collapsed-stat-label">סה"כ</span><span class="collapsed-stat-value ok" style="font-weight: 800;">${Utils.fmt(totalBalance)}</span></div>
                        </div>
                        <div style="margin-right: auto; color: var(--muted);"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></div>`;
                
                return { preview: previewHtml, collapsed: collapsedHtml };
            },

            // Updates a specific track's preview in DOM
            updateTrackPreview: (trackId) => {
                const params = UI.readAllInputsForTrack(trackId);
                if (!params) return;
                const result = Calculator.simulate(params);
                const html = UI.generatePreviewHTML(result, params);
                
                const previewEl = Utils.$(`trackPreview_${trackId}`);
                if (previewEl) previewEl.innerHTML = html.preview;
                
                const collapsedEl = Utils.$(`trackCollapsed_${trackId}`);
                if (collapsedEl) collapsedEl.innerHTML = html.collapsed;
            },

            // Batch update for all tracks to avoid layout thrashing
            updateAllPreviews: () => {
                const common = UI.readCommonInputs();
                const cards = document.querySelectorAll('.track-card');
                
                // Phase 1: Read and Calculate (JS only)
                const updates = Array.from(cards).map(card => {
                    const trackId = card.dataset.trackId;
                    const trackParams = UI.readTrackInputs(trackId);
                    const params = { ...common, ...trackParams };
                    const result = Calculator.simulate(params);
                    const html = UI.generatePreviewHTML(result, params);
                    return { trackId, html };
                });

                // Phase 2: Write to DOM (One reflow pass ideally)
                updates.forEach(({ trackId, html }) => {
                    const previewEl = Utils.$(`trackPreview_${trackId}`);
                    if (previewEl) previewEl.innerHTML = html.preview;
                    
                    const collapsedEl = Utils.$(`trackCollapsed_${trackId}`);
                    if (collapsedEl) collapsedEl.innerHTML = html.collapsed;
                });
            },

            // -- Logic Helpers within UI --
            updateCalculatedEntranceFeeRate: (trackId) => {
                const years = Utils.unformat(Utils.$(`entranceFeeDepreciationYears_${trackId}`)?.value);
                const amount = Utils.unformat(Utils.$(`entranceFeeAmount_${trackId}`)?.value);
                const rateInput = Utils.$(`entranceFeeDepreciationRateMonthly_${trackId}`);
                
                if (rateInput && years > 0) {
                    const ratePercent = 100 / (years * 12);
                    const monthlyDepAmount = amount / (years * 12);
                    rateInput.value = (amount > 0 && isFinite(monthlyDepAmount)) 
                        ? `${ratePercent.toFixed(3)}% (${Utils.fmt(monthlyDepAmount)} ₪)` 
                        : `${ratePercent.toFixed(3)}%`;
                } else if (rateInput) {
                    rateInput.value = '0.000%';
                }
            },

            updateRefundPctNote: (trackId) => {
                const years = Utils.unformat(Utils.$(`depositDepreciationYears_${trackId}`)?.value);
                const depPct = Utils.unformat(Utils.$(`depositDepreciationPct_${trackId}`)?.value);
                const note = Utils.$(`refundPctNote_${trackId}`);
                
                if (note) {
                    let refundPct = Math.max(0, 100 - (years * depPct));
                    note.textContent = `(החזר מינימלי: ${refundPct.toFixed(1)}%)`;
                }
            },
            
            updateDepositReduction: (trackId) => {
                const reducedDepositInput = Utils.$(`reducedDepositAmount_${trackId}`);
                const maintenanceInput = Utils.$(`baseWithDeposit_${trackId}`);
                const depositInput = Utils.$(`depositAmount_${trackId}`);

                if (!reducedDepositInput || !maintenanceInput || !depositInput) return;
                
                const baseMaintenance = Utils.unformat(maintenanceInput.dataset.baseValue);
                const baseDeposit = Utils.unformat(depositInput.dataset.baseValue);
                let reducedAmount = Utils.unformat(reducedDepositInput.value);

                // Cap reduction amount
                if (reducedAmount > baseDeposit) {
                    reducedAmount = baseDeposit;
                    reducedDepositInput.value = Utils.formatNumber(reducedAmount);
                }
                
                const maintenanceIncrease = (reducedAmount / 50000) * 500;
                maintenanceInput.value = Utils.formatNumber(Math.max(0, baseMaintenance + maintenanceIncrease));
                depositInput.value = Utils.formatNumber(Math.max(0, baseDeposit - reducedAmount));
            },

            updateVacancyMonthsNote: () => {
                const note = Utils.$('vacancyMonthsNote');
                const pct = Utils.unformat(Utils.$('vacancyPct')?.value);
                if (note && !isNaN(pct) && pct !== '') {
                     const months = (pct / 100) * 12;
                     note.textContent = `(שווה ערך לכ-${(months % 1 === 0 ? months.toFixed(0) : months.toFixed(1))} חודשים)`;
                } else if (note) {
                    note.textContent = '';
                }
            },

            setupNumberFormatting: (container) => {
                container.querySelectorAll('input[type="text"][inputmode="decimal"]').forEach(input => {
                    // Initial format
                    if (input.value && !input.value.includes(',')) {
                        input.value = Utils.formatNumber(input.value);
                    }

                    input.addEventListener('input', (e) => {
                        const target = e.target;
                        const originalValue = target.value;
                        const cursorPos = target.selectionStart;
                        
                        // Performance: Count digits only if needed
                        const digitsToRight = originalValue.length - cursorPos; 
                        
                        const formattedValue = Utils.formatNumber(originalValue);
                        if (originalValue === formattedValue) return;
                        
                        target.value = formattedValue;
                        
                        // Maintain cursor position logic (optimized)
                        // Simple approximation often works, but here is robust logic:
                        const newLength = formattedValue.length;
                        const oldLength = originalValue.length;
                        let newPos = cursorPos;
                        
                        // Adjust cursor if commas were added/removed
                        if (newLength !== oldLength) {
                            // Rough adjust: keep distance from right same
                            newPos = newLength - digitsToRight;
                            if(newPos < 0) newPos = 0;
                        }
                        
                        target.setSelectionRange(newPos, newPos);
                    });
                });
            },

            renderResultsModal: () => {
                const container = Utils.$('resultsTableContainer');
                const targetYear = parseFloat(Utils.$('yearSlider').value);
                const targetMonths = Math.round(targetYear * 12);
                
                const pricingModeMap = { 'deposit': 'עם פיקדון', 'entrance_fee': 'דמי כניסה', 'none': 'ללא' };

                let table = `<table class="results-table"><thead><tr>
                    <th>שם החברה-סוג החדר</th><th>סוג מסלול</th><th>סה"כ חודשים (עצמאי / סיעודי)</th>
                    <th class="tooltip-header">עלות מצטברת כוללת (₪)<span class="tooltip-text">סך כל ההוצאות...</span></th>
                    <th class="tooltip-header">עלות השחיקה (₪)<span class="tooltip-text">החלק היחסי של הפיקדון...</span></th>
                    <th class="tooltip-header">עלות דמי אחזקה (₪)<span class="tooltip-text">סך התשלומים השוטפים...</span></th>
                    <th class="tooltip-header">יתרת הון בסיום (₪)<span class="tooltip-text">ההון הנזיל שנותר...</span></th>
                    <th class="tooltip-header">החזר צפוי (₪)<span class="tooltip-text">הסכום שיתקבל חזרה...</span></th>
                    <th>תזרים חודשי ראשון (₪)</th>
                </tr></thead><tbody>`;

                State.simulationResults.forEach(result => {
                    const rSummary = result.summary;
                    let displayMonths = 0, indMonths = 0, nursMonths = 0, finalCash = 0, refundEnd = 0,
                        cumulativeDepreciation = 0, cumulativeMaintenance = 0, totalEconomicCost = 0, durationNote = '';
                    let rowClass = '';

                    const ranOut = !rSummary.maxedOut;
                    const showInsolvent = ranOut && rSummary.totalMonths < targetMonths;
                    const hasLog = result.monthlyLog.length > 0;

                    if (!hasLog) {
                         rowClass = 'insolvent';
                         durationNote = '<div class="note danger">לא מספיק הון להתחלה</div>';
                    } else if (showInsolvent) {
                        rowClass = 'insolvent';
                        const last = result.monthlyLog[result.monthlyLog.length - 1];
                        displayMonths = last.month; indMonths = last.independentMonths; nursMonths = last.nursingMonths;
                        refundEnd = last.refund;
                        
                        const calcLogs = result.monthlyLog;
                        cumulativeMaintenance = calcLogs.reduce((s, l) => s + (l.providerCost || 0), 0);
                        const totalEconomic = calcLogs.reduce((s, l) => s + (l.providerEconomicCost || 0), 0);
                        cumulativeDepreciation = totalEconomic - cumulativeMaintenance;
                        totalEconomicCost = totalEconomic + (calcLogs.reduce((s, l) => s + (l.totalCost || 0), 0) - cumulativeMaintenance);

                        const y = Math.floor(displayMonths / 12);
                        const m = displayMonths % 12;
                        durationNote = `<div class="note danger">ההון אזל לאחר ${y} שנים ו־${m} חודשים</div>`;
                    } else {
                        // Healthy case or not yet insolvent
                        const cappedMonths = Math.min(targetMonths, rSummary.totalMonths);
                        const logs = result.monthlyLog.slice(0, cappedMonths);
                        const last = logs[logs.length - 1];
                        
                        displayMonths = last.month; indMonths = last.independentMonths; nursMonths = last.nursingMonths;
                        finalCash = last.cash; refundEnd = last.refund;
                        
                        cumulativeMaintenance = logs.reduce((s, l) => s + (l.providerCost || 0), 0);
                        const totalEconomic = logs.reduce((s, l) => s + (l.providerEconomicCost || 0), 0);
                        cumulativeDepreciation = totalEconomic - cumulativeMaintenance;
                        totalEconomicCost = totalEconomic + (logs.reduce((s, l) => s + (l.totalCost || 0), 0) - cumulativeMaintenance);
                        
                        const y = Math.floor(displayMonths / 12);
                        const m = displayMonths % 12;
                        durationNote = `<div class="note">${y} שנים ו־${m} חודשים</div>`;
                    }

                    // Mobile headers map
                    const mHeaders = ['שם החברה', 'סוג מסלול', 'סה"כ חודשים', 'עלות מצטברת', 'עלות שחיקה', 'עלות אחזקה', 'יתרת הון', 'החזר צפוי', 'תזרים ראשון'];

                    // Initial Params for First Month Flow
                    const initP = UI.readAllInputsForTrack(rSummary.trackId);
                    const base = initP.pricingMode === 'deposit' ? initP.baseWithDeposit : (initP.pricingMode === 'entrance_fee' ? initP.baseWithEntranceFee : initP.baseNoDeposit);
                    const rent = initP.scenario === 'rent' ? Math.max(0, (initP.rentGross * (1 - initP.rentTaxPct) * (1 - initP.vacancyPct)) - (initP.annualMaintenance / 12)) : 0;
                    const indNet = (initP.monthlyIncome + rent) - (base + initP.monthlyLivingExpenses);

                    // Tooltip Construction
                    let tooltip = '';
                    if (initP.pricingMode === 'deposit') {
                         tooltip = `<div style="font-weight:bold;margin-bottom:5px;color:var(--accent);">פרטי מסלול פיקדון</div><div>דמי אחזקה: <b>${Utils.fmt(initP.baseWithDeposit)} ₪</b></div><div>סכום פיקדון: <b>${Utils.fmt(initP.depositAmount)} ₪</b></div><div>פחת שנתי: <b>${(initP.depositDepreciationPct * 100).toFixed(1)}%</b></div><div>שנים: <b>${initP.depositDepreciationYears}</b></div>`;
                    } else if (initP.pricingMode === 'entrance_fee') {
                         tooltip = `<div style="font-weight:bold;margin-bottom:5px;color:var(--accent);">פרטי מסלול דמי כניסה</div><div>דמי אחזקה: <b>${Utils.fmt(initP.baseWithEntranceFee)} ₪</b></div><div>דמי כניסה: <b>${Utils.fmt(initP.entranceFeeAmount)} ₪</b></div>`;
                    } else {
                         tooltip = `<div style="font-weight:bold;margin-bottom:5px;color:var(--accent);">פרטי מסלול שכירות</div><div>דמי אחזקה: <b>${Utils.fmt(initP.baseNoDeposit)} ₪</b></div>`;
                    }

                    table += `<tr class="${rowClass}">
                        <td data-label="${mHeaders[0]}"><span class="tooltip-header">${Utils.escapeHtml(rSummary.trackName)}<span class="tooltip-text">${tooltip}</span></span></td>
                        <td data-label="${mHeaders[1]}">${pricingModeMap[rSummary.pricingMode]}</td>
                        <td data-label="${mHeaders[2]}"><b>${Utils.fmt(displayMonths)} (${Utils.fmt(indMonths)} / ${Utils.fmt(nursMonths)})</b>${durationNote}</td>
                        <td data-label="${mHeaders[3]}">${Utils.fmt(totalEconomicCost)}</td>
                        <td data-label="${mHeaders[4]}">${Utils.fmt(cumulativeDepreciation)}</td>
                        <td data-label="${mHeaders[5]}">${Utils.fmt(cumulativeMaintenance)}</td>
                        <td data-label="${mHeaders[6]}">${Utils.fmt(finalCash)}</td>
                        <td data-label="${mHeaders[7]}">${Utils.fmt(refundEnd)}</td>
                        <td data-label="${mHeaders[8]}">
                            <span class="income">${Utils.fmt(initP.monthlyIncome + rent)}</span> /
                            <span class="expense">${Utils.fmt(base + initP.monthlyLivingExpenses)}</span> /
                            <b class="${indNet >= 0 ? 'ok' : 'danger'}">${Utils.fmt(indNet)}</b>
                        </td>
                    </tr>`;
                });
                
                table += '</tbody></table>';
                container.innerHTML = table;
            },

            setupYearSlider: () => {
                const slider = Utils.$('yearSlider');
                const bubble = Utils.$('sliderValueBubble');
                const ticks = Utils.$('sliderTicksContainer');
                
                const maxYears = Math.max(0.5, Utils.unformat(Utils.$('maxYears').value) || 15, ...State.simulationResults.map(r => Math.ceil(r.summary.totalMonths / 12)));
                const min = 0.5;
                
                slider.min = min; slider.max = maxYears; slider.value = maxYears;
                
                // Draw Ticks
                ticks.innerHTML = '';
                const numTicks = Math.floor(maxYears);
                let step = numTicks > 50 ? 10 : (numTicks > 20 ? 5 : 1);

                for (let i = 1; i <= numTicks; i++) {
                    if (i > 0 && i % step !== 0 && i !== numTicks && numTicks > 10) continue;
                    const pct = ((i - min) / (maxYears - min)) * 100;
                    if (pct >= 0 && pct <= 100) {
                        const tick = document.createElement('div'); tick.className = 'slider-tick'; tick.style.right = `${pct}%`;
                        const label = document.createElement('span'); label.className = 'slider-tick-label'; label.textContent = i; label.style.right = `${pct}%`;
                        ticks.append(tick, label);
                    }
                }

                // Update UI Function
                const update = () => {
                    const val = parseFloat(slider.value);
                    Utils.$('yearSliderLabel').textContent = `הצג תוצאות לאחר: ${val} שנים`;
                    bubble.innerHTML = `${val} שנים`;
                    const pct = (maxYears - min) > 0 ? ((val - min) / (maxYears - min)) * 100 : 0;
                    bubble.style.right = `${pct}%`;
                    slider.style.setProperty('--slider-fill-percent', `${pct}%`);
                };

                slider.oninput = () => { update(); UI.renderResultsModal(); };
                update();
            }
        };

        // --- Event Orchestration ---
        const Events = {
            init: () => {
                // Initialize DragManager
                DragManager.init();

                // Initial Format
                UI.setupNumberFormatting(document.body);
                UI.updateVacancyMonthsNote();

                // Common Inputs Listeners (Debounced Calculation Trigger for previews)
                const debouncedPreviewUpdate = Utils.debounce((trackId) => {
                    if (trackId) {
                        UI.updateTrackPreview(trackId);
                    } else {
                        // Optimized: Batch update for all tracks to prevent Layout Thrashing
                        UI.updateAllPreviews();
                    }
                }, 100); // Reduce debounce to 100ms for snappier feel

                // Global Click Handler (Delegation)
                document.addEventListener('click', (e) => {
                    const target = e.target;
                    
                    // Spinner Buttons
                    if (target.matches('.spinner-btn:not(.stepper-btn)')) {
                        Events.handleSpinner(target);
                    }
                    // Stepper Buttons (Deposit Reduction)
                    else if (target.classList.contains('stepper-btn')) {
                        Events.handleStepper(target);
                    }
                    // Remove Track
                    else if (target.dataset.removeTrackId) {
                        const id = target.dataset.removeTrackId;
                        State.removeTrack(id);
                        document.querySelector(`.track-card[data-track-id='${id}']`).remove();
                    }
                    // Toggle Track
                    else if (target.closest('.toggle-track-btn')) {
                         const btn = target.closest('.toggle-track-btn');
                         const card = document.querySelector(`.track-card[data-track-id='${btn.dataset.toggleTrackId}']`);
                         if(card) card.classList.toggle('collapsed');
                    }
                    // Expand on click collapsed
                    else if (target.closest('.track-card.collapsed') && !target.closest('.remove-track-btn') && !target.closest('.drag-handle')) {
                        target.closest('.track-card.collapsed').classList.remove('collapsed');
                    }
                });

                // Global Change/Input Handler
                const container = Utils.$('tracksContainer');
                container.addEventListener('change', (e) => {
                    if (e.target.id.startsWith('pricingMode_')) {
                        UI.updateTrackBody(e.target.id.split('_')[1]);
                    }
                });
                
                container.addEventListener('input', (e) => {
                    const id = e.target.id;
                    const trackId = e.target.dataset.trackId || e.target.closest('.track-card')?.dataset.trackId;
                    
                    if (id.startsWith('entranceFee')) UI.updateCalculatedEntranceFeeRate(trackId);
                    if (id.startsWith('reducedDeposit')) UI.updateDepositReduction(trackId);
                    if (id.startsWith('depositDepreciation')) UI.updateRefundPctNote(trackId);

                    // Reset base value logic for manual overrides
                    if (id.startsWith('baseWithDeposit_') || id.startsWith('depositAmount_')) {
                        e.target.dataset.baseValue = Utils.unformat(e.target.value);
                        const redInput = Utils.$(`reducedDepositAmount_${trackId}`);
                        if (redInput && redInput.value !== '0' && redInput.value !== '') {
                            redInput.value = Utils.formatNumber('0');
                            // Recalc reduction to 0 to sync fields
                            UI.updateDepositReduction(trackId);
                            // Resync base values
                            const otherId = id.startsWith('base') ? `depositAmount_${trackId}` : `baseWithDeposit_${trackId}`;
                            const otherInput = Utils.$(otherId);
                            if(otherInput) otherInput.dataset.baseValue = Utils.unformat(otherInput.value);
                        }
                    }

                    if (trackId) debouncedPreviewUpdate(trackId);
                });

                // Common Inputs Change
                Utils.$('commonInputsCard').addEventListener('input', () => debouncedPreviewUpdate());
                Utils.$('topBarSettings').addEventListener('input', () => debouncedPreviewUpdate());
                Utils.$('vacancyPct').addEventListener('input', UI.updateVacancyMonthsNote);

                // Feature Toggles
                Utils.$('isNursing').addEventListener('change', (e) => Utils.$('nursingFieldsRow').style.display = e.target.checked ? 'grid' : 'none');
                Utils.$('assetScenarioSelect').addEventListener('change', (e) => {
                    Utils.$('sellBlock').style.display = e.target.value === 'sell' ? 'block' : 'none';
                    Utils.$('rentBlock').style.display = e.target.value === 'rent' ? 'block' : 'none';
                });

                // Buttons
                Utils.$('addTrackBtn').addEventListener('click', () => {
                    const t = State.addTrack();
                    UI.renderTrackCard(t);
                    if (window.innerWidth <= 600) setTimeout(() => document.querySelector(`.track-card[data-track-id='${t.id}']`)?.scrollIntoView({behavior:'smooth', block:'nearest'}), 100);
                });

                Utils.$('toggleAllTracksBtn').addEventListener('click', Events.toggleAllTracks);
                Utils.$('calculateBtn').addEventListener('click', Events.runCalculation);
                Utils.$('closeModalBtn').addEventListener('click', () => Utils.$('resultsModal').classList.remove('visible'));
                Utils.$('resultsModal').addEventListener('click', (e) => { if (e.target.id === 'resultsModal') Utils.$('resultsModal').classList.remove('visible'); });

                // Import/Export
                Utils.$('exportBtn').addEventListener('click', Events.exportData);
                Utils.$('importBtn').addEventListener('click', () => Utils.$('importFile').click());
                Utils.$('importFile').addEventListener('change', Events.importData);

                // Add initial track
                const t = State.addTrack();
                UI.renderTrackCard(t);
            },

            handleSpinner: (btn) => {
                const { stepDir, target: targetId } = btn.dataset;
                const input = Utils.$(targetId);
                if (!input) return;

                let val = Utils.unformat(input.value);
                
                // Determine step
                const id = input.id;
                let step = 500;
                if (id.includes('Pct') || id.includes('Return') || id.includes('Inflation')) step = 0.5;
                else if (id.toLowerCase().includes('years')) step = 1;
                else if (id.includes('monthsIndependent')) step = 6;
                else {
                    const abs = Math.abs(val);
                    if (abs >= 1000000) step = 100000;
                    else if (abs >= 100000) step = 10000;
                    else if (abs >= 10000) step = 1000;
                }

                val += (stepDir === 'up' ? step : -step);
                input.value = Utils.formatNumber(Math.max(0, val));
                input.dispatchEvent(new Event('input', { bubbles: true }));
            },

            handleStepper: (btn) => {
                const { trackId, stepDir } = btn.dataset;
                const redInput = Utils.$(`reducedDepositAmount_${trackId}`);
                const depInput = Utils.$(`depositAmount_${trackId}`);
                
                const cur = Utils.unformat(redInput.value);
                const step = 50000;
                const next = cur + (stepDir === 'up' ? step : -step);
                
                if (next < 0) return;
                const baseDep = Utils.unformat(depInput.dataset.baseValue);
                if (stepDir === 'up' && (baseDep - next) < 0) { alert('לא ניתן להפחית יותר מסכום הפיקדון המקורי.'); return; }

                redInput.value = Utils.formatNumber(next);
                UI.updateDepositReduction(trackId);
                UI.updateTrackPreview(trackId);
            },

            toggleAllTracks: () => {
                const cards = document.querySelectorAll('.track-card');
                if (!cards.length) return;
                const anyExpanded = Array.from(cards).some(c => !c.classList.contains('collapsed'));
                cards.forEach(c => c.classList.toggle('collapsed', anyExpanded));
                
                const btn = Utils.$('toggleAllTracksBtn');
                const tooltip = Utils.$('toggleAllTooltip');
                btn.innerHTML = anyExpanded ? Constants.ICONS.expand : Constants.ICONS.collapse;
                const txt = anyExpanded ? 'הרחב הכל' : 'כווץ הכל';
                btn.setAttribute('aria-label', txt);
                if(tooltip) tooltip.textContent = txt;
            },

            runCalculation: () => {
                 const cards = document.querySelectorAll('.track-card');
                 if (cards.length === 0) { alert('יש להוסיף לפחות מסלול אחד.'); return; }
                 
                 // We need to read freshly because simulation might not have run for everything yet
                 // Or we can just use readAllInputsForTrack per card
                 State.simulationResults = Array.from(cards).map(c => {
                     return Calculator.simulate(UI.readAllInputsForTrack(c.dataset.trackId));
                 });

                 UI.setupYearSlider();
                 UI.renderResultsModal();
                 Utils.$('resultsModal').classList.add('visible');
            },

            exportData: () => {
                try {
                    const data = { common: {}, tracks: [] };
                    document.querySelectorAll('#commonInputsCard input, #commonInputsCard select, .top-bar-settings input').forEach(inp => {
                        data.common[inp.id] = inp.type === 'checkbox' ? inp.checked : inp.value;
                    });
                    document.querySelectorAll('.track-card').forEach(card => {
                        const tData = {};
                        card.querySelectorAll('input, select').forEach(inp => {
                            const key = inp.id.split('_')[0];
                            tData[key] = inp.value;
                            if (inp.dataset.baseValue) tData[key + '_base'] = inp.dataset.baseValue;
                        });
                        data.tracks.push(tData);
                    });
                    
                    const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'calculator-data.json';
                    a.click();
                    URL.revokeObjectURL(url);
                } catch(e) { console.error(e); alert('שגיאה בייצוא'); }
            },

            importData: (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const r = new FileReader();
                r.onload = (ev) => {
                    try {
                        const d = JSON.parse(ev.target.result);
                        if (!d.common || !d.tracks) throw new Error();
                        
                        // Apply Common
                        Object.keys(d.common).forEach(k => {
                            const el = Utils.$(k);
                            if(el) {
                                if(el.type === 'checkbox') el.checked = d.common[k];
                                else el.value = d.common[k];
                                el.dispatchEvent(new Event('change'));
                            }
                        });

                        // Rebuild Tracks
                        Utils.$('tracksContainer').innerHTML = '';
                        State.clearTracks();
                        
                        d.tracks.forEach(td => {
                            const t = State.addTrack();
                            // Render blank first to create DOM
                            UI.renderTrackCard(t);
                            
                            // Fill Data
                            Utils.$(`pricingMode_${t.id}`).value = td.pricingMode;
                            UI.updateTrackBody(t.id);
                            
                            // Legacy mapping for files where trackName existed but company/room didn't
                            if (td.trackName && !td.trackCompany) {
                                const compEl = Utils.$(`trackCompany_${t.id}`);
                                if (compEl) compEl.value = td.trackName;
                            }

                            Object.keys(td).forEach(k => {
                                const isBase = k.endsWith('_base');
                                const realK = isBase ? k.replace('_base','') : k;
                                const el = Utils.$(`${realK}_${t.id}`);
                                if(el) {
                                    if(isBase) el.dataset.baseValue = td[k];
                                    else el.value = td[k];
                                }
                            });
                            
                            // Migration (Legacy support for Refund Pct -> Years)
                            if (td.pricingMode === 'deposit' && td.depositRefundPct && !td.depositDepreciationYears) {
                                const pct = parseFloat(td.depositRefundPct);
                                const depPct = parseFloat(td.depositDepreciationPct || 3);
                                if(depPct > 0) Utils.$(`depositDepreciationYears_${t.id}`).value = Utils.formatNumber((100 - pct)/depPct);
                            }

                            // Trigger Calcs
                            UI.setupNumberFormatting(document.querySelector(`.track-card[data-track-id='${t.id}']`));
                            if(td.pricingMode === 'deposit') UI.updateDepositReduction(t.id);
                            if(td.pricingMode === 'entrance_fee') UI.updateCalculatedEntranceFeeRate(t.id);
                        });
                        
                        // Force update all previews
                        UI.updateAllPreviews();

                        // Reset Collapse
                        // Quick dirty reset to expanded
                        const cards = document.querySelectorAll('.track-card');
                        cards.forEach(c => c.classList.remove('collapsed'));
                        const btn = Utils.$('toggleAllTracksBtn');
                        btn.innerHTML = Constants.ICONS.collapse;
                        
                        alert('הנתונים יובאו בהצלחה!');
                    } catch(err) { console.error(err); alert('קובץ לא תקין'); }
                    e.target.value = null;
                };
                r.readAsText(file);
            }
        };

        return { init: Events.init };
    })();

    // Start App
    document.addEventListener('DOMContentLoaded', App.init);
  </script>
</body>
</html>