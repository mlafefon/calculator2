<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מחשבון השוואת מסלולי דיור מוגן</title>
  <style>
    :root {
      --bg: #0f172a;          /* slate-900 */
      --panel: #1e293b;       /* slate-800 */
      --muted: #94a3b8;       /* slate-400 */
      --text: #e5e7eb;        /* gray-200 */
      --accent: #22d3ee;      /* cyan-400 */
      --accent-2: #34d399;    /* emerald-400 */
      --danger: #fb7185;      /* rose-400 */
      --warn: #f59e0b;        /* amber-500 */
      --ok: #10b981;          /* emerald-500 */
      --card: #111827;
      --input: #1e293b;
      --border: #334155;      /* slate-700 */
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text); font-family: system-ui, Segoe UI, Arial, "Noto Sans Hebrew", sans-serif; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 2.25rem; margin: 0 0 8px; text-align: center; color: var(--accent); }
    h2 { font-size: 1.5rem; margin: 24px 0 16px; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 8px; }
    h3 { font-size: 1.1rem; color: var(--muted); margin: 16px 0 8px; }
    p.subtitle { color: var(--muted); margin: 0 0 24px; text-align: center; max-width: 700px; margin-left: auto; margin-right: auto; line-height: 1.6; }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 24px; }
    .span-12 { grid-column: span 12; }
    .span-8 { grid-column: span 8; }
    .span-6 { grid-column: span 6; }
    .span-4 { grid-column: span 4; }
    .span-3 { grid-column: span 3; }
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; margin-bottom: 16px; align-items: end; }
    label { font-size: 0.9rem; color: var(--muted); display: block; margin-bottom: 6px; }
    label .help-icon { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; border: 1px solid var(--muted); color: var(--muted); font-size: 11px; font-weight: bold; margin-right: 6px; cursor: pointer; user-select: none; transition: all 0.2s; }
    label .help-icon:hover { background: var(--accent); color: var(--card); border-color: var(--accent); }
    input, select { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--input); color: var(--text); font-size: 0.95rem; transition: border-color 0.2s, box-shadow 0.2s; }
    input:focus, select:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(34,211,238,.15); }
    input.income, select.income { color: var(--ok); }
    input.expense, select.expense { color: var(--danger); }
    input[type="checkbox"] { width: auto; accent-color: var(--accent); }
    .btn { cursor: pointer; background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #001018; border: none; padding: 12px 16px; border-radius: 12px; font-weight: 700; transition: transform 0.2s, box-shadow 0.2s; }
    .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .btn.secondary { background: transparent; color: var(--text); border: 1px solid var(--border); }
    .btn.secondary:hover:not(:disabled) { background: var(--panel); border-color: var(--accent); }
    .btn.danger { background: var(--danger); color: var(--text); border: none; }
    .btn.danger:hover:not(:disabled) { background: #f43f5e; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .note { font-size: .85rem; color: var(--muted); }
    .inline-row { display: flex; align-items: center; gap: 8px; }
    .hr { border-top: 1px dashed var(--border); margin: 24px 0; }
    
    #tracksContainer .track-card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px; position: relative; }
    .track-header { display: flex; gap: 16px; margin-bottom: 16px; align-items: center; }
    .track-header .form-group { flex-grow: 1; }
    
    #resultsSection { display: none; }
    .results-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    .results-table th, .results-table td { padding: 12px; text-align: center; border-bottom: 1px solid var(--border); }
    .results-table th { color: var(--accent); font-size: 0.9rem; }
    .results-table td { font-size: 1rem; }
    .results-table tr:last-child td { border-bottom: none; }
    .results-table td:first-child { font-weight: bold; text-align: right; }
    .breakdown-cell { font-size: .8rem; text-align: right; padding: 4px; }
    .breakdown-cell table { width: 100%; }
    .breakdown-cell td:last-child { text-align: left; direction: ltr; }
    
    #sliderGroup { margin-top: 24px; padding: 16px; background: var(--panel); border-radius: 12px; }
    #yearSlider { width: 100%; accent-color: var(--accent); }
    #sliderLabels { display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--muted); margin-top: 8px; }

    @media (max-width: 900px) {
      .span-8, .span-6, .span-4, .span-3 { grid-column: span 12; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>מחשבון השוואת מסלולי דיור מוגן</h1>
    <p class="subtitle">הכלי מאפשר להשוות תרחישים פיננסיים שונים למגורים בדיור מוגן. התחילו בהזנת הנתונים הכלליים, הגדירו את מסלולי התמחור שברצונכם לבחון, ולבסוף השוו את התוצאות כדי לקבל החלטה מושכלת.</p>

    <!-- Step 1: Common Inputs -->
    <div class="card">
      <h2>שלב 1: נתונים כלליים ונכס</h2>
      <h3>פרמטרים פיננסיים</h3>
      <div class="row">
        <div class="span-3"><label for="initCash">הון נזיל התחלתי (₪)</label><input type="text" id="initCash" value="1500000" class="income" inputmode="decimal"/></div>
        <div class="span-3"><label for="monthlyIncome">הכנסה חודשית קבועה (₪)</label><input type="text" id="monthlyIncome" value="5500" class="income" inputmode="decimal"/></div>
        <div class="span-3"><label for="monthlyLivingExpenses">הוצאות מחייה חודשיות (₪)</label><input type="text" id="monthlyLivingExpenses" value="1500" class="expense" inputmode="decimal"/></div>
        <div class="span-3"><label for="oneTimeCosts">עלויות חד־פעמיות (₪)</label><input type="text" id="oneTimeCosts" value="0" class="expense" inputmode="decimal"/></div>
      </div>
      <div class="row">
        <div class="span-4"><label for="annualReturn">תשואת ריבית שנתית על היתרה (%)</label><input type="text" id="annualReturn" value="1" class="income" inputmode="decimal"/></div>
        <div class="span-4"><label for="annualInflation">קצב התייקרות שנתי (מדד) (%)</label><input type="text" id="annualInflation" value="2" class="expense" inputmode="decimal"/></div>
        <div class="span-4"><label for="maxYears">מגבלת סימולציה (שנים)</label><input type="text" id="maxYears" value="15" inputmode="decimal"/></div>
      </div>
      
      <div class="hr"></div>
      <h3>מצב סיעודי</h3>
      <div class="row">
        <div class="span-12"><label class="inline-row"><input id="isNursing" type="checkbox"/> להפעיל תרחיש מצב סיעודי</label></div>
      </div>
      <div class="row" id="nursingFieldsRow" style="display: none;">
        <div class="span-4"><label for="monthsIndependent">חודשים בתפקוד מלא</label><input type="text" id="monthsIndependent" value="60" inputmode="decimal"/></div>
        <div class="span-4"><label for="nursingAddon">תוספת חודשית במצב סיעודי (₪)</label><input type="text" id="nursingAddon" value="18000" class="expense" inputmode="decimal"/></div>
        <div class="span-4"><label for="nursingAllowance">גמלת סיעוד לקיזוז (₪/חודש)</label><input type="text" id="nursingAllowance" value="2000" class="income" inputmode="decimal"/></div>
      </div>

      <div class="hr"></div>
      <h3>תרחיש נכס</h3>
      <div class="row">
        <div class="span-4">
            <label for="assetScenarioSelect">בחר תרחיש עבור הדירה</label>
            <select id="assetScenarioSelect">
                <option value="sell" selected>מכירת הדירה</option>
                <option value="rent">השכרת הדירה</option>
                <option value="none">ללא שימוש בדירה</option>
            </select>
        </div>
      </div>
      <div id="sellBlock">
        <div class="row">
          <div class="span-6"><label for="salePrice">מחיר מכירה (₪)</label><input type="text" id="salePrice" value="3000000" class="income" inputmode="decimal"/></div>
          <div class="span-6"><label for="saleCostsPct">עלויות עסקה (% מהמחיר)</label><input type="text" id="saleCostsPct" value="3" class="expense" inputmode="decimal"/></div>
        </div>
      </div>
      <div id="rentBlock" style="display: none;">
        <div class="row">
          <div class="span-3"><label for="rentGross">שכ"ד חודשי ברוטו (₪)</label><input type="text" id="rentGross" value="7000" class="income" inputmode="decimal"/></div>
          <div class="span-3"><label for="rentTaxPct">מס על שכ"ד (%)</label><input type="text" id="rentTaxPct" value="10" class="expense" inputmode="decimal"/></div>
          <div class="span-3"><label for="vacancyPct">חודשים פנויים בשנה (%)</label><input type="text" id="vacancyPct" value="8" class="expense" inputmode="decimal"/></div>
          <div class="span-3"><label for="annualMaintenance">תחזוקה שנתית (₪)</label><input type="text" id="annualMaintenance" value="6000" class="expense" inputmode="decimal"/></div>
        </div>
      </div>
    </div>
    
    <!-- Step 2: Tracks Definition -->
    <div class="card">
        <h2>שלב 2: הגדרת מסלולים להשוואה</h2>
        <div id="tracksContainer"></div>
        <button id="addTrackBtn" class="btn secondary" style="margin-top: 16px;">+ הוסף מסלול חדש</button>
    </div>

    <!-- Calculate Button -->
    <button id="calculateBtn" class="btn" style="width: 100%; padding: 16px; font-size: 1.2rem; margin-top: 16px;">השווה מסלולים</button>

    <!-- Step 3: Results -->
    <div class="card" id="resultsSection">
        <h2>שלב 3: השוואת תוצאות</h2>
        <div id="resultsTableContainer" style="overflow-x: auto;"></div>
        
        <div id="sliderGroup">
            <h3>ניתוח עלות מצטברת לפי שנים</h3>
            <label for="yearSlider" id="yearSliderLabel">בחר שנה</label>
            <input type="range" id="yearSlider" min="1" max="15" value="1" style="width:100%;">
            <div id="sliderLabels">
                <span id="sliderMinLabel">שנה 1</span>
                <span id="sliderMaxLabel">שנה 15</span>
            </div>
            <div id="cumulativeCostTableContainer" style="margin-top: 16px;"></div>
        </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const fmt = (n) => n === null || isNaN(n) ? '—' : new Intl.NumberFormat('he-IL').format(Math.round(n));
    const unformat = (val) => +(val || '0').toString().replace(/,/g, '');

    // --- State Management ---
    let tracks = [];
    let simulationResults = [];

    // --- Core Simulation Logic ---
    function simulate(p) {
        if (!p.isNursing) p.monthsIndependent = Infinity;

        let cash = p.initCash;
        if (p.scenario === 'sell') cash += Math.max(0, p.salePrice * (1 - p.saleCostsPct));
        
        let depositBook = 0;
        let entranceFeeBook = 0;

        if (p.pricingMode === 'deposit' && p.depositAmount > 0) {
            cash -= p.depositAmount;
            depositBook = p.depositAmount;
        }
        if (p.pricingMode === 'entrance_fee' && p.entranceFeeAmount > 0) {
            cash -= p.entranceFeeAmount;
            entranceFeeBook = p.entranceFeeAmount;
        }
        cash -= p.oneTimeCosts;

        const monthlyLog = [];

        if (cash < 0) {
             const summary = { totalMonths: 0, independentMonths: 0, nursingMonths: 0, refundEnd: p.pricingMode === 'deposit' ? p.depositAmount : p.entranceFeeAmount, finalCash: 0, trackName: p.trackName };
            return { summary, monthlyLog };
        }

        const monthlyReturn = Math.pow(1 + p.annualReturn, 1/12) - 1;
        const monthlyInfl = Math.pow(1 + p.annualInflation, 1/12) - 1;
        const maxMonths = p.maxYears > 0 ? p.maxYears * 12 : 50 * 12;

        const baseMonthlyCost = (t, mode) => {
            let base;
            if (mode === 'deposit') base = p.baseWithDeposit;
            else if (mode === 'entrance_fee') base = p.baseWithEntranceFee;
            else base = p.baseNoDeposit;
            return base * Math.pow(1 + monthlyInfl, t);
        };
        const nursingExtra = (t) => (Math.max(0, p.nursingAddon - p.nursingAllowance)) * Math.pow(1 + monthlyInfl, t);
        const rentNetPerMonth = (t) => {
            if (p.scenario !== 'rent') return 0;
            const gross = p.rentGross * Math.pow(1 + monthlyInfl, t);
            return Math.max(0, (gross * (1 - p.rentTaxPct) * (1 - p.vacancyPct)) - (p.annualMaintenance / 12));
        };
        const monthlyLivingCost = (t) => p.monthlyLivingExpenses * Math.pow(1 + monthlyInfl, t);

        let t = 0, independentMonths = 0, nursingMonths = 0, lastPositiveCash = cash;

        while (t < maxMonths) {
            cash *= (1 + monthlyReturn);
            const totalMonthlyCost = baseMonthlyCost(t, p.pricingMode) + ((t < p.monthsIndependent) ? 0 : nursingExtra(t)) + monthlyLivingCost(t);
            const income = p.monthlyIncome + rentNetPerMonth(t);
            cash += (income - totalMonthlyCost);
            
            monthlyLog.push({ month: t + 1, totalCost: totalMonthlyCost });

            if (p.pricingMode === 'deposit' && depositBook > 0 && t < (12 * 12)) {
                const monthlyDep = 1 - Math.pow(1 - (p.depositDepreciationPct || 0), 1/12);
                depositBook *= (1 - monthlyDep);
            }
            if (p.pricingMode === 'entrance_fee' && entranceFeeBook > 0 && t < (p.entranceFeeDepreciationYears * 12)) {
                const monthlyDepAmount = p.entranceFeeAmount * (p.entranceFeeDepreciationRateMonthly || 0);
                entranceFeeBook = Math.max(0, entranceFeeBook - monthlyDepAmount);
            }

            if (cash < 0) break;
            
            if (t < p.monthsIndependent) independentMonths++; else nursingMonths++;
            lastPositiveCash = cash;
            t++;
        }

        let refundEnd = 0;
        if (p.pricingMode === 'deposit') {
            const floor = (p.depositAmount || 0) * (p.depositRefundPct || 0);
            refundEnd = Math.max(0, Math.max(depositBook, floor));
        } else if (p.pricingMode === 'entrance_fee') {
            refundEnd = entranceFeeBook;
        }

        const summary = { totalMonths: t, independentMonths, nursingMonths, refundEnd, finalCash: lastPositiveCash, trackName: p.trackName, maxedOut: t >= maxMonths };
        return { summary, monthlyLog };
    }


    // --- UI Rendering ---
    function renderTrackCard(track) {
        const trackId = track.id;
        const card = document.createElement('div');
        card.className = 'track-card';
        card.dataset.trackId = trackId;
        card.innerHTML = `
            <div class="track-header">
                <div class="form-group"><label for="trackName_${trackId}">שם המסלול</label><input type="text" id="trackName_${trackId}" value="${track.name}" placeholder="לדוגמה: בית א׳ - מסלול פיקדון"></div>
                <div class="form-group"><label for="pricingMode_${trackId}">סוג המסלול</label>
                    <select id="pricingMode_${trackId}">
                        <option value="deposit" ${track.pricingMode === 'deposit' ? 'selected' : ''}>עם פיקדון</option>
                        <option value="entrance_fee" ${track.pricingMode === 'entrance_fee' ? 'selected' : ''}>דמי כניסה</option>
                        <option value="none" ${track.pricingMode === 'none' ? 'selected' : ''}>ללא</option>
                    </select>
                </div>
                <button class="btn danger" data-remove-track-id="${trackId}" style="align-self: flex-end;">הסר</button>
            </div>
            <div class="track-body"></div>`;

        $('tracksContainer').appendChild(card);
        updateTrackBody(trackId);
    }
    
    function updateTrackBody(trackId) {
        const card = document.querySelector(`.track-card[data-track-id='${trackId}']`);
        const body = card.querySelector('.track-body');
        const mode = card.querySelector(`#pricingMode_${trackId}`).value;

        let html = '<div class="row">';
        if (mode === 'deposit') {
            html += `
                <div class="span-3"><label for="baseWithDeposit_${trackId}">דמי אחזקה (₪)</label><input type="text" id="baseWithDeposit_${trackId}" value="9000" class="expense" inputmode="decimal"></div>
                <div class="span-3"><label for="depositAmount_${trackId}">סכום פיקדון (₪)</label><input type="text" id="depositAmount_${trackId}" value="1000000" class="income" inputmode="decimal"></div>
                <div class="span-3"><label for="depositDepreciationPct_${trackId}">פחת פיקדון שנתי (%)</label><input type="text" id="depositDepreciationPct_${trackId}" value="3" class="expense" inputmode="decimal"></div>
                <div class="span-3"><label for="depositRefundPct_${trackId}">אחוז החזר מינימלי (%)</label><input type="text" id="depositRefundPct_${trackId}" value="80" class="income" inputmode="decimal"></div>`;
        } else if (mode === 'entrance_fee') {
            html += `
                <div class="span-3"><label for="baseWithEntranceFee_${trackId}">דמי אחזקה (₪)</label><input type="text" id="baseWithEntranceFee_${trackId}" value="9500" class="expense" inputmode="decimal"></div>
                <div class="span-3"><label for="entranceFeeAmount_${trackId}">סכום דמי כניסה (₪)</label><input type="text" id="entranceFeeAmount_${trackId}" value="450000" class="income" inputmode="decimal"></div>
                <div class="span-3"><label for="entranceFeeDepreciationRateMonthly_${trackId}">פחת חודשי (%)</label><input type="text" id="entranceFeeDepreciationRateMonthly_${trackId}" value="1.5" class="expense" inputmode="decimal"></div>
                <div class="span-3"><label for="entranceFeeDepreciationYears_${trackId}">משך הפחת (שנים)</label><input type="text" id="entranceFeeDepreciationYears_${trackId}" value="5" class="expense" inputmode="decimal"></div>`;
        } else { // none
            html += `<div class="span-3"><label for="baseNoDeposit_${trackId}">דמי אחזקה (₪)</label><input type="text" id="baseNoDeposit_${trackId}" value="14000" class="expense" inputmode="decimal"></div>`;
        }
        html += '</div>';
        body.innerHTML = html;
        setupNumberFormattingForContainer(body);
    }
    
    function renderResults() {
        const container = $('resultsTableContainer');
        const results = simulationResults.map(r => r.summary);
        
        let table = `<table class="results-table"><thead><tr>
            <th>מסלול</th>
            <th>סה"כ חודשים</th>
            <th>פירוט חודשים (עצמאי / סיעודי)</th>
            <th>יתרת הון בסיום (₪)</th>
            <th>החזר צפוי (₪)</th>
            <th>תזרים חודשי ראשון (₪)</th>
        </tr></thead><tbody>`;

        results.forEach(r => {
            const years = Math.floor(r.totalMonths / 12), months = r.totalMonths % 12;
            const durationText = r.maxedOut ? `+${r.totalMonths}` : r.totalMonths;
            const durationNote = r.totalMonths > 0 ? `<div class="note">${years} שנים ו־${months} חודשים</div>` : '<div class="note">לא מספיק להתחלה</div>';
            
            // First month cash flow
            const firstMonthParams = readAllInputsForTrack(r.trackName); // Assuming trackName is unique
            const baseCost = (firstMonthParams.pricingMode === 'deposit') ? firstMonthParams.baseWithDeposit : (firstMonthParams.pricingMode === 'entrance_fee') ? firstMonthParams.baseWithEntranceFee : firstMonthParams.baseNoDeposit;
            const livingExpenses = firstMonthParams.monthlyLivingExpenses;
            const fixedIncome = firstMonthParams.monthlyIncome;
            const rentIncome = (firstMonthParams.scenario === 'rent') ? Math.max(0, (firstMonthParams.rentGross * (1 - firstMonthParams.rentTaxPct) * (1 - firstMonthParams.vacancyPct)) - (firstMonthParams.annualMaintenance / 12)) : 0;
            const indNet = (fixedIncome + rentIncome) - (baseCost + livingExpenses);

            table += `<tr>
                <td>${r.trackName}</td>
                <td><b>${durationText}</b>${durationNote}</td>
                <td>${fmt(r.independentMonths)} / ${fmt(r.nursingMonths)}</td>
                <td>${fmt(r.finalCash)}</td>
                <td>${fmt(r.refundEnd)}</td>
                <td class="breakdown-cell">
                    <table>
                        <tr><td>הכנסות</td><td class="income">${fmt(fixedIncome + rentIncome)}</td></tr>
                        <tr><td>הוצאות</td><td class="expense">${fmt(baseCost + livingExpenses)}</td></tr>
                        <tr><td><b>יתרה</b></td><td class="${indNet >= 0 ? 'ok' : 'danger'}"><b>${fmt(indNet)}</b></td></tr>
                    </table>
                </td>
            </tr>`;
        });

        table += '</tbody></table>';
        container.innerHTML = table;
        $('resultsSection').style.display = 'block';
    }

    function renderCumulativeCostTable(year) {
        const container = $('cumulativeCostTableContainer');
        let table = `<table class="results-table"><thead><tr>
            <th>מסלול</th>
            <th>עלות מצטברת כוללת עד סוף שנה ${year} (₪)</th>
        </tr></thead><tbody>`;
        
        simulationResults.forEach(result => {
            const targetMonths = year * 12;
            const cumulativeCost = result.monthlyLog
                .filter(log => log.month <= targetMonths)
                .reduce((sum, log) => sum + log.totalCost, 0);
            
            table += `<tr><td>${result.summary.trackName}</td><td>${fmt(cumulativeCost)}</td></tr>`;
        });
        
        table += '</tbody></table>';
        container.innerHTML = table;
    }

    // --- Input Reading ---
    function readAllInputsForTrack(trackName) {
        const trackCard = Array.from(document.querySelectorAll('.track-card')).find(c => c.querySelector('input[id^="trackName"]').value === trackName);
        if (!trackCard) return null;
        const trackId = trackCard.dataset.trackId;
        const pMode = $(`pricingMode_${trackId}`).value;

        const trackParams = {
            trackName: trackName,
            pricingMode: pMode,
            baseWithDeposit: pMode === 'deposit' ? unformat($(`baseWithDeposit_${trackId}`).value) : 0,
            baseWithEntranceFee: pMode === 'entrance_fee' ? unformat($(`baseWithEntranceFee_${trackId}`).value) : 0,
            baseNoDeposit: pMode === 'none' ? unformat($(`baseNoDeposit_${trackId}`).value) : 0,
            depositAmount: pMode === 'deposit' ? unformat($(`depositAmount_${trackId}`).value) : 0,
            depositDepreciationPct: pMode === 'deposit' ? unformat($(`depositDepreciationPct_${trackId}`).value) / 100 : 0,
            depositRefundPct: pMode === 'deposit' ? unformat($(`depositRefundPct_${trackId}`).value) / 100 : 0,
            entranceFeeAmount: pMode === 'entrance_fee' ? unformat($(`entranceFeeAmount_${trackId}`).value) : 0,
            entranceFeeDepreciationRateMonthly: pMode === 'entrance_fee' ? unformat($(`entranceFeeDepreciationRateMonthly_${trackId}`).value) / 100 : 0,
            entranceFeeDepreciationYears: pMode === 'entrance_fee' ? unformat($(`entranceFeeDepreciationYears_${trackId}`).value) : 0,
        };
        
        const commonParams = {
            isNursing: $('isNursing').checked,
            initCash: unformat($('initCash').value),
            monthlyIncome: unformat($('monthlyIncome').value),
            monthlyLivingExpenses: unformat($('monthlyLivingExpenses').value),
            oneTimeCosts: unformat($('oneTimeCosts').value),
            annualReturn: unformat($('annualReturn').value) / 100,
            annualInflation: unformat($('annualInflation').value) / 100,
            maxYears: unformat($('maxYears').value),
            monthsIndependent: unformat($('monthsIndependent').value),
            nursingAddon: unformat($('nursingAddon').value),
            nursingAllowance: unformat($('nursingAllowance').value),
            scenario: $('assetScenarioSelect').value,
            salePrice: unformat($('salePrice').value),
            saleCostsPct: unformat($('saleCostsPct').value) / 100,
            rentGross: unformat($('rentGross').value),
            rentTaxPct: unformat($('rentTaxPct').value) / 100,
            vacancyPct: unformat($('vacancyPct').value) / 100,
            annualMaintenance: unformat($('annualMaintenance').value),
        };

        return { ...commonParams, ...trackParams };
    }


    // --- Event Handlers & Setup ---
    function handleAddTrack() {
        const newTrack = {
            id: Date.now(),
            name: `מסלול ${tracks.length + 1}`,
            pricingMode: 'deposit'
        };
        tracks.push(newTrack);
        renderTrackCard(newTrack);
    }
    
    function handleCalculate() {
        const trackNames = Array.from(document.querySelectorAll('input[id^="trackName"]')).map(input => input.value);
        if (trackNames.length === 0) {
            alert('יש להוסיף לפחות מסלול אחד להשוואה.');
            return;
        }

        simulationResults = trackNames.map(name => {
            const params = readAllInputsForTrack(name);
            return simulate(params);
        });

        renderResults();
        setupYearSlider();
    }
    
    function setupYearSlider() {
        const slider = $('yearSlider');
        const maxYears = Math.max(1, ...simulationResults.map(r => Math.ceil(r.summary.totalMonths / 12)), unformat($('maxYears').value) || 15);
        
        slider.max = maxYears;
        slider.value = 1;
        $('sliderMinLabel').textContent = 'שנה 1';
        $('sliderMaxLabel').textContent = `שנה ${maxYears}`;

        const updateSliderDisplay = () => {
            const year = slider.value;
            $('yearSliderLabel').textContent = `ניתוח עלות מצטברת עד סוף שנה ${year}`;
            renderCumulativeCostTable(year);
        };

        slider.oninput = updateSliderDisplay;
        updateSliderDisplay(); // Initial render
    }

    // --- Utilities ---
    const formatNumber = (v) => {
        if (v === '' || v === null || v === undefined) return '';
        const clean = v.toString().replace(/[^0-9.]/g, '');
        if (clean === '') return '';
        const parts = clean.split('.');
        const integerPart = new Intl.NumberFormat('he-IL').format(Number(parts[0]));
        return parts.length > 1 ? `${integerPart}.${parts[1]}` : integerPart;
    };
    
    function setupNumberFormattingForContainer(container) {
        container.querySelectorAll('input[type="text"][inputmode="decimal"]').forEach(input => {
            input.value = formatNumber(input.value);
            input.addEventListener('input', (e) => {
                const { target } = e;
                const originalValue = target.value;
                const cursorPos = target.selectionStart;
                const digitsToRight = (originalValue.substring(cursorPos).match(/\d/g) || []).length;
                
                const formattedValue = formatNumber(originalValue);
                if (originalValue === formattedValue) return;
                target.value = formattedValue;
                
                let newCursorPos = formattedValue.length;
                if (digitsToRight > 0) {
                    let digitsCounted = 0;
                    for (let i = formattedValue.length - 1; i >= 0; i--) {
                        if (/\d/.test(formattedValue[i])) digitsCounted++;
                        if (digitsCounted === digitsToRight) {
                            newCursorPos = i;
                            break;
                        }
                    }
                }
                target.setSelectionRange(newCursorPos, newCursorPos);
            });
        });
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => { 
        // Initial setup for common inputs
        setupNumberFormattingForContainer(document.body);
        
        $('isNursing').addEventListener('change', (e) => {
            $('nursingFieldsRow').style.display = e.target.checked ? 'grid' : 'none';
        });

        $('assetScenarioSelect').addEventListener('change', (e) => {
            const scenario = e.target.value;
            $('sellBlock').style.display = scenario === 'sell' ? 'block' : 'none';
            $('rentBlock').style.display = scenario === 'rent' ? 'block' : 'none';
        });

        // Track management
        $('addTrackBtn').addEventListener('click', handleAddTrack);
        $('tracksContainer').addEventListener('click', (e) => {
            if (e.target.dataset.removeTrackId) {
                const trackId = e.target.dataset.removeTrackId;
                tracks = tracks.filter(t => t.id != trackId);
                document.querySelector(`.track-card[data-track-id='${trackId}']`).remove();
            }
        });
        $('tracksContainer').addEventListener('change', (e) => {
            if (e.target.id.startsWith('pricingMode_')) {
                const trackId = e.target.id.split('_')[1];
                updateTrackBody(trackId);
            }
        });

        // Calculation
        $('calculateBtn').addEventListener('click', handleCalculate);
        
        // Add one track by default
        handleAddTrack();
    });
  </script>
</body>
</html>