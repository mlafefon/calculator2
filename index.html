<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מחשבון השוואת מסלולי דיור מוגן</title>
  <style>
    :root {
      --bg: #0f172a;          /* slate-900 */
      --panel: #1e293b;       /* slate-800 */
      --muted: #94a3b8;       /* slate-400 */
      --text: #e5e7eb;        /* gray-200 */
      --accent: #22d3ee;      /* cyan-400 */
      --accent-2: #34d399;    /* emerald-400 */
      --danger: #fb7185;      /* rose-400 */
      --warn: #f59e0b;        /* amber-500 */
      --ok: #10b981;          /* emerald-500 */
      --card: #111827;
      --input: #1e293b;
      --border: #334155;      /* slate-700 */
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text); font-family: system-ui, Segoe UI, Arial, "Noto Sans Hebrew", sans-serif; }
    body { padding-top: 70px; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 2.25rem; margin: 0 0 8px; text-align: center; color: var(--accent); }
    h2 { font-size: 1.5rem; margin: 24px 0 16px; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 8px; }
    h3 { font-size: 1.1rem; color: var(--muted); margin: 16px 0 8px; }
    p.subtitle { color: var(--muted); margin: 0 0 24px; text-align: center; max-width: 700px; margin-left: auto; margin-right: auto; line-height: 1.6; }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 24px; }
    .span-12 { grid-column: span 12; }
    .span-8 { grid-column: span 8; }
    .span-6 { grid-column: span 6; }
    .span-4 { grid-column: span 4; }
    .span-3 { grid-column: span 3; }
    .span-2 { grid-column: span 2; }
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; margin-bottom: 16px; align-items: end; }
    label { font-size: 0.9rem; color: var(--muted); display: block; margin-bottom: 6px; }
    label .help-icon { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; border: 1px solid var(--muted); color: var(--muted); font-size: 11px; font-weight: bold; margin-right: 6px; cursor: pointer; user-select: none; transition: all 0.2s; }
    label .help-icon:hover { background: var(--accent); color: var(--card); border-color: var(--accent); }
    input, select { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--input); color: var(--text); font-size: 0.95rem; transition: border-color 0.2s, box-shadow 0.2s; }
    input:focus, select:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(34,211,238,.15); }
    .income, .ok { color: var(--ok); }
    .expense, .danger { color: var(--danger); }
    input[type="checkbox"] { width: auto; accent-color: var(--accent); }
    .btn { cursor: pointer; background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #001018; border: none; padding: 12px 16px; border-radius: 12px; font-weight: 700; transition: transform 0.2s, box-shadow 0.2s; }
    .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .btn.secondary { background: transparent; color: var(--text); border: 1px solid var(--border); }
    .btn.secondary:hover:not(:disabled) { background: var(--panel); border-color: var(--accent); }
    .btn.danger { background: var(--danger); color: var(--text); border: none; }
    .btn.danger:hover:not(:disabled) { background: #f43f5e; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .note { font-size: .85rem; color: var(--muted); }
    .note.danger { color: var(--danger); font-weight: 500; }
    .inline-row { display: flex; align-items: center; gap: 8px; }
    .hr { border-top: 1px dashed var(--border); margin: 24px 0; }
    
    #tracksContainer .track-card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px; position: relative; }
    .track-header { display: flex; gap: 16px; margin-bottom: 16px; align-items: center; }
    .track-header .form-group { flex-grow: 1; }
    
    .results-table { width: 100%; border-collapse: collapse; }
    .results-table th, .results-table td { padding: 12px; text-align: center; border-bottom: 1px solid var(--border); }
    .results-table th { color: var(--accent); font-size: 0.9rem; background: var(--panel); }
    .results-table td { font-size: 1rem; }
    .results-table tr:last-child td { border-bottom: none; }
    .results-table tr.insolvent { background-color: rgba(251, 113, 133, 0.1); }
    .results-table thead {
      position: sticky;
      top: 188px; /* Height of modal-header (76px) + slider (~112px) */
      z-index: 9;
    }
    .breakdown-cell { font-size: .8rem; text-align: right; padding: 4px; }
    .breakdown-cell table { width: 100%; }
    .breakdown-cell td:last-child { text-align: left; direction: ltr; }
    
    #sliderGroup {
        margin-bottom: 0;
        padding: 16px 24px;
        background: var(--panel);
        border-radius: 0;
        position: sticky;
        top: 76px; /* After modal-header which is ~76px high */
        z-index: 10;
    }
    #yearSlider { width: 100%; accent-color: var(--accent); }
    #sliderLabels { display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--muted); margin-top: 8px; }

    .spinner-control {
        display: flex;
        align-items: stretch;
        max-width: 240px;
    }
    .spinner-control input {
        flex-grow: 1;
        text-align: center;
        border-left: none;
        border-right: none;
        border-radius: 0;
    }
    .spinner-btn {
        flex: 0 0 40px;
        background: var(--panel);
        color: var(--text);
        border: 1px solid var(--border);
        cursor: pointer;
        font-size: 1.2rem;
        line-height: 1;
        transition: background .2s, border-color .2s;
        padding: 0;
    }
    .spinner-btn:hover:not(:disabled) {
        background: var(--accent);
        color: var(--bg);
        border-color: var(--accent);
    }
    .spinner-control > .spinner-btn:first-child { /* Rightmost in RTL */
        border-radius: 0 10px 10px 0;
    }
    .spinner-control > .spinner-btn:last-child { /* Leftmost in RTL */
        border-radius: 10px 0 0 10px;
    }
    .spinner-control input:focus {
        position: relative;
        z-index: 1;
    }
    
    .tooltip-header {
      position: relative;
      cursor: help;
      text-decoration: underline;
      text-decoration-style: dotted;
    }
    .tooltip-text {
      visibility: hidden;
      width: 280px;
      background-color: var(--panel);
      color: var(--text);
      text-align: right;
      border-radius: 8px;
      padding: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      position: absolute;
      z-index: 9999;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-weight: normal;
      font-size: 0.85rem;
      line-height: 1.5;
      pointer-events: none;
    }
    .tooltip-header:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    .tooltip-text::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: var(--border) transparent transparent transparent;
    }

    /* Top Bar */
    .top-bar {
        background: var(--panel);
        padding: 12px 24px;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 1000;
        border-bottom: 1px solid var(--border);
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .top-bar-container {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: flex-end;
        align-items: center;
    }
    .top-bar .actions {
        display: flex;
        gap: 16px;
    }

    /* Results Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay.visible {
        opacity: 1;
        visibility: visible;
    }
    .modal-content {
        background: var(--bg);
        padding: 0;
        border-radius: 0;
        border: none;
        width: 100%;
        height: 100%;
        max-width: none;
        max-height: none;
        overflow-y: auto;
        position: relative;
        transform: scale(0.95);
        transition: transform 0.3s;
    }
    .modal-overlay.visible .modal-content {
        transform: scale(1);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 12;
    }
    .modal-header h2 {
      margin: 0;
      color: var(--accent);
    }
    .modal-close {
        position: relative;
        top: auto;
        left: auto;
        background: var(--panel);
        border: 1px solid var(--border);
        color: var(--text);
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
        padding: 0;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1;
        box-shadow: none;
        transition: background-color 0.2s, transform 0.2s;
        flex-shrink: 0;
    }
    .modal-close:hover {
        color: var(--bg);
        background-color: var(--accent);
        transform: scale(1.1);
    }
    #resultsTableContainer {
      padding: 0 24px 24px;
    }


    @media (max-width: 900px) {
      .span-8, .span-6, .span-4, .span-3, .span-2 { grid-column: span 12; }
    }
  </style>
</head>
<body>
  <div class="top-bar">
      <div class="top-bar-container">
          <div class="actions">
              <input type="file" id="importFile" accept=".json" style="display:none;">
              <button id="importBtn" class="btn secondary">ייבוא נתונים</button>
              <button id="exportBtn" class="btn secondary">ייצוא נתונים</button>
              <button id="calculateBtn" class="btn">השווה מסלולים</button>
          </div>
      </div>
  </div>

  <div class="container">
    <h1>מחשבון השוואת מסלולי דיור מוגן</h1>
    <p class="subtitle">הכלי מאפשר להשוות תרחישים פיננסיים שונים למגורים בדיור מוגן. התחילו בהזנת הנתונים הכלליים, הגדירו את מסלולי התמחור שברצונכם לבחון, ולבסוף השוו את התוצאות כדי לקבל החלטה מושכלת.</p>

    <!-- Step 1: Common Inputs -->
    <div class="card" id="commonInputsCard">
      <h2>שלב 1: נתונים כלליים ונכס</h2>
      <h3>פרמטרים פיננסיים</h3>
      <div class="row">
        <div class="span-3"><label for="initCash">הון נזיל התחלתי (₪)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="initCash">+</button><input type="text" id="initCash" value="1500000" class="income" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="initCash">-</button></div></div>
        <div class="span-3"><label for="monthlyIncome">הכנסה חודשית קבועה (₪)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="monthlyIncome">+</button><input type="text" id="monthlyIncome" value="5500" class="income" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="monthlyIncome">-</button></div></div>
        <div class="span-3"><label for="monthlyLivingExpenses">הוצאות מחייה חודשיות (₪)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="monthlyLivingExpenses">+</button><input type="text" id="monthlyLivingExpenses" value="1500" class="expense" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="monthlyLivingExpenses">-</button></div></div>
        <div class="span-3">
            <label for="oneTimeCosts">
                <span class="tooltip-header">עלויות חד־פעמיות (₪)
                    <span class="tooltip-text">מכסה הוצאות גדולות ומיידיות הקשורות למעבר, שאינן הפיקדון או דמי הכניסה. למשל: הובלה, ריהוט, שיפוץ קל, או עמלות. סכום זה יופחת מההון הנזיל ההתחלתי שלך ביום הראשון של הסימולציה.</span>
                </span>
            </label>
            <div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="oneTimeCosts">+</button><input type="text" id="oneTimeCosts" value="0" class="expense" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="oneTimeCosts">-</button></div>
        </div>
      </div>
      <div class="row">
        <div class="span-4"><label for="annualReturn">תשואת ריבית שנתית על היתרה (%)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="annualReturn">+</button><input type="text" id="annualReturn" value="1" class="income" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="annualReturn">-</button></div></div>
        <div class="span-4"><label for="annualInflation">קצב התייקרות שנתי (מדד) (%)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="annualInflation">+</button><input type="text" id="annualInflation" value="2" class="expense" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="annualInflation">-</button></div></div>
        <div class="span-4"><label for="maxYears">מגבלת סימולציה (שנים)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="maxYears">+</button><input type="text" id="maxYears" value="15" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="maxYears">-</button></div></div>
      </div>
      
      <div class="hr"></div>
      <h3>מצב סיעודי</h3>
      <div class="row">
        <div class="span-12"><label class="inline-row"><input id="isNursing" type="checkbox"/> להפעיל תרחיש מצב סיעודי</label></div>
      </div>
      <div class="row" id="nursingFieldsRow" style="display: none;">
        <div class="span-4"><label for="monthsIndependent">חודשים בתפקוד מלא</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="monthsIndependent">+</button><input type="text" id="monthsIndependent" value="60" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="monthsIndependent">-</button></div></div>
        <div class="span-4"><label for="nursingAddon">תוספת חודשית במצב סיעודי (₪)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="nursingAddon">+</button><input type="text" id="nursingAddon" value="18000" class="expense" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="nursingAddon">-</button></div></div>
        <div class="span-4"><label for="nursingAllowance">גמלת סיעוד לקיזוז (₪/חודש)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="nursingAllowance">+</button><input type="text" id="nursingAllowance" value="2000" class="income" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="nursingAllowance">-</button></div></div>
      </div>

      <div class="hr"></div>
      <h3>תרחיש נכס</h3>
      <div class="row">
        <div class="span-4">
            <label for="assetScenarioSelect">בחר תרחיש עבור הדירה</label>
            <select id="assetScenarioSelect">
                <option value="sell">מכירת הדירה</option>
                <option value="rent" selected>השכרת הדירה</option>
                <option value="none">ללא שימוש בדירה</option>
            </select>
        </div>
      </div>
      <div id="sellBlock" style="display: none;">
        <div class="row">
          <div class="span-6"><label for="salePrice">מחיר מכירה (₪)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="salePrice">+</button><input type="text" id="salePrice" value="3000000" class="income" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="salePrice">-</button></div></div>
          <div class="span-6"><label for="saleCostsPct">עלויות עסקה (% מהמחיר)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="saleCostsPct">+</button><input type="text" id="saleCostsPct" value="3" class="expense" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="saleCostsPct">-</button></div></div>
        </div>
      </div>
      <div id="rentBlock">
        <div class="row">
          <div class="span-3"><label for="rentGross">שכ"ד חודשי ברוטו (₪)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="rentGross">+</button><input type="text" id="rentGross" value="7000" class="income" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="rentGross">-</button></div></div>
          <div class="span-3"><label for="rentTaxPct">מס על שכ"ד (%)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="rentTaxPct">+</button><input type="text" id="rentTaxPct" value="10" class="expense" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="rentTaxPct">-</button></div></div>
          <div class="span-3"><label for="vacancyPct">חודשים פנויים בשנה (%)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="vacancyPct">+</button><input type="text" id="vacancyPct" value="8" class="expense" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="vacancyPct">-</button></div></div>
          <div class="span-3"><label for="annualMaintenance">תחזוקה שנתית (₪)</label><div class="spinner-control"><button type="button" class="spinner-btn" data-step-dir="up" data-target="annualMaintenance">+</button><input type="text" id="annualMaintenance" value="6000" class="expense" inputmode="decimal"/><button type="button" class="spinner-btn" data-step-dir="down" data-target="annualMaintenance">-</button></div></div>
        </div>
      </div>
    </div>
    
    <!-- Step 2: Tracks Definition -->
    <div class="card" id="tracksCard">
        <h2>שלב 2: הגדרת מסלולים להשוואה</h2>
        <div id="tracksContainer"></div>
        <button id="addTrackBtn" class="btn secondary" style="margin-top: 16px;">+ הוסף מסלול חדש</button>
    </div>

  </div>

  <!-- Results Modal -->
  <div id="resultsModal" class="modal-overlay">
      <div class="modal-content">
          <div class="modal-header">
              <h2>שלב 3: השוואת תוצאות</h2>
              <button id="closeModalBtn" class="modal-close" aria-label="סגור חלון">&times;</button>
          </div>

          <div id="sliderGroup">
              <label for="yearSlider" id="yearSliderLabel">הצג תוצאות לאחר:</label>
              <input type="range" id="yearSlider" list="yearTicks" min="0.5" max="15" value="15" step="0.5">
              <datalist id="yearTicks"></datalist>
              <div id="sliderLabels">
                  <span id="sliderMinLabel">חצי שנה</span>
                  <span id="sliderMaxLabel">שנה 15</span>
              </div>
          </div>

          <div id="resultsTableContainer"></div>
      </div>
  </div>


  <script>
    const $ = (id) => document.getElementById(id);
    const fmt = (n) => n === null || isNaN(n) ? '—' : new Intl.NumberFormat('he-IL').format(Math.round(n));
    const unformat = (val) => +(val || '0').toString().replace(/,/g, '');

    // --- State Management ---
    let tracks = [];
    let simulationResults = [];

    // --- Core Simulation Logic ---
    function simulate(p) {
        let cash = p.initCash;
        if (p.scenario === 'sell') cash += Math.max(0, p.salePrice * (1 - p.saleCostsPct));
        
        let depositBook = 0;
        let entranceFeeBook = 0;

        if (p.pricingMode === 'deposit' && p.depositAmount > 0) {
            cash -= p.depositAmount;
            depositBook = p.depositAmount;
        }
        if (p.pricingMode === 'entrance_fee' && p.entranceFeeAmount > 0) {
            cash -= p.entranceFeeAmount;
            entranceFeeBook = p.entranceFeeAmount;
        }
        cash -= p.oneTimeCosts;

        const monthlyLog = [];

        if (cash < 0) {
             const summary = { totalMonths: 0, independentMonths: 0, nursingMonths: 0, refundEnd: p.pricingMode === 'deposit' ? p.depositAmount : p.entranceFeeAmount, finalCash: 0, trackId: p.id, trackName: p.trackName, maxedOut: false, pricingMode: p.pricingMode };
            return { summary, monthlyLog };
        }

        const monthlyReturn = Math.pow(1 + p.annualReturn, 1/12) - 1;
        const monthlyInfl = Math.pow(1 + p.annualInflation, 1/12) - 1;
        const maxMonths = p.maxYears > 0 ? p.maxYears * 12 : 50 * 12;

        const baseMonthlyCost = (t, mode) => {
            let base;
            if (mode === 'deposit') base = p.baseWithDeposit;
            else if (mode === 'entrance_fee') base = p.baseWithEntranceFee;
            else base = p.baseNoDeposit;
            return base * Math.pow(1 + monthlyInfl, t);
        };
        const nursingExtra = (t) => (Math.max(0, p.nursingAddon - p.nursingAllowance)) * Math.pow(1 + monthlyInfl, t);
        const rentNetPerMonth = (t) => {
            if (p.scenario !== 'rent') return 0;
            const gross = p.rentGross * Math.pow(1 + monthlyInfl, t);
            return Math.max(0, (gross * (1 - p.rentTaxPct) * (1 - p.vacancyPct)) - (p.annualMaintenance / 12));
        };
        const monthlyLivingCost = (t) => p.monthlyLivingExpenses * Math.pow(1 + monthlyInfl, t);

        let t = 0, independentMonths = 0, nursingMonths = 0, lastPositiveCash = cash;

        while (t < maxMonths) {
            cash *= (1 + monthlyReturn);
            const providerMonthlyCost = baseMonthlyCost(t, p.pricingMode) + (p.isNursing && t >= p.monthsIndependent ? nursingExtra(t) : 0);
            const totalMonthlyCost = providerMonthlyCost + monthlyLivingCost(t);
            const income = p.monthlyIncome + rentNetPerMonth(t);
            cash += (income - totalMonthlyCost);
            
            let depreciationThisMonth = 0;
            if (p.pricingMode === 'deposit' && depositBook > 0 && t < (12 * 12)) {
                const monthlyDepRate = 1 - Math.pow(1 - (p.depositDepreciationPct || 0), 1/12);
                depreciationThisMonth = depositBook * monthlyDepRate;
                depositBook *= (1 - monthlyDepRate);
            }
            if (p.pricingMode === 'entrance_fee' && entranceFeeBook > 0 && t < (p.entranceFeeDepreciationYears * 12)) {
                const monthlyDepAmount = p.entranceFeeAmount * (p.entranceFeeDepreciationRateMonthly || 0);
                const actualDepreciation = Math.min(entranceFeeBook, monthlyDepAmount);
                depreciationThisMonth = actualDepreciation;
                entranceFeeBook = Math.max(0, entranceFeeBook - monthlyDepAmount);
            }
            
            const providerEconomicCost = providerMonthlyCost + depreciationThisMonth;

            if (cash < 0) break;
            
            if (p.isNursing && t >= p.monthsIndependent) nursingMonths++; else independentMonths++;
            lastPositiveCash = cash;
            
            let refundCurrent = 0;
            if (p.pricingMode === 'deposit') {
                const floor = (p.depositAmount || 0) * (p.depositRefundPct || 0);
                refundCurrent = Math.max(0, Math.max(depositBook, floor));
            } else if (p.pricingMode === 'entrance_fee') {
                refundCurrent = entranceFeeBook;
            }
            
            monthlyLog.push({ month: t + 1, totalCost: totalMonthlyCost, providerCost: providerMonthlyCost, providerEconomicCost, cash: lastPositiveCash, refund: refundCurrent, independentMonths, nursingMonths });
            
            t++;
        }

        let refundEnd = 0;
        if (p.pricingMode === 'deposit') {
            const floor = (p.depositAmount || 0) * (p.depositRefundPct || 0);
            refundEnd = Math.max(0, Math.max(depositBook, floor));
        } else if (p.pricingMode === 'entrance_fee') {
            refundEnd = entranceFeeBook;
        }

        const summary = { totalMonths: t, independentMonths, nursingMonths, refundEnd, finalCash: lastPositiveCash, trackId: p.id, trackName: p.trackName, maxedOut: t >= maxMonths, pricingMode: p.pricingMode };
        return { summary, monthlyLog };
    }

    // --- Modal Management ---
    function showResultsModal() {
        $('resultsModal').classList.add('visible');
    }

    function hideResultsModal() {
        $('resultsModal').classList.remove('visible');
    }

    // --- UI Rendering ---
    function renderTrackCard(track) {
        const trackId = track.id;
        const card = document.createElement('div');
        card.className = 'track-card';
        card.dataset.trackId = trackId;
        card.innerHTML = `
            <div class="track-header">
                <div class="form-group"><label for="trackName_${trackId}">שם החברה-סוג החדר</label><input type="text" id="trackName_${trackId}" value="${track.name}" placeholder="לדוגמה: פאלאס - דירת 2 חדרים"></div>
                <div class="form-group"><label for="pricingMode_${trackId}">סוג המסלול</label>
                    <select id="pricingMode_${trackId}">
                        <option value="deposit" ${track.pricingMode === 'deposit' ? 'selected' : ''}>עם פיקדון</option>
                        <option value="entrance_fee" ${track.pricingMode === 'entrance_fee' ? 'selected' : ''}>דמי כניסה</option>
                        <option value="none" ${track.pricingMode === 'none' ? 'selected' : ''}>ללא</option>
                    </select>
                </div>
                <button class="btn danger" data-remove-track-id="${trackId}" style="align-self: flex-end;">הסר</button>
            </div>
            <div class="track-body"></div>`;

        $('tracksContainer').appendChild(card);
        updateTrackBody(trackId);
    }
    
    function updateCalculatedEntranceFeeRate(trackId) {
        const yearsInput = $(`entranceFeeDepreciationYears_${trackId}`);
        const rateInput = $(`entranceFeeDepreciationRateMonthly_${trackId}`);
        const amountInput = $(`entranceFeeAmount_${trackId}`);
        if (!yearsInput || !rateInput || !amountInput) return;

        const years = unformat(yearsInput.value);
        const amount = unformat(amountInput.value);
        
        if (years > 0) {
            const ratePercent = 100 / (years * 12);
            const monthlyDepAmount = amount / (years * 12);
            
            if (amount > 0 && isFinite(monthlyDepAmount)) {
                rateInput.value = `${ratePercent.toFixed(3)}% (${fmt(monthlyDepAmount)} ₪)`;
            } else {
                rateInput.value = `${ratePercent.toFixed(3)}%`;
            }
        } else {
            rateInput.value = '0.000%';
        }
    }
    
    function updateTrackBody(trackId) {
        const card = document.querySelector(`.track-card[data-track-id='${trackId}']`);
        const body = card.querySelector('.track-body');
        const mode = card.querySelector(`#pricingMode_${trackId}`).value;

        let html = '<div class="row">';
        if (mode === 'deposit') {
            html += `
                <div class="span-2">
                    <label for="baseWithDeposit_${trackId}">דמי אחזקה (₪)</label>
                    <div class="spinner-control">
                        <button type="button" class="spinner-btn" data-step-dir="up" data-target="baseWithDeposit_${trackId}">+</button>
                        <input type="text" id="baseWithDeposit_${trackId}" data-track-id="${trackId}" data-base-value="9000" value="9000" class="expense" inputmode="decimal">
                        <button type="button" class="spinner-btn" data-step-dir="down" data-target="baseWithDeposit_${trackId}">-</button>
                    </div>
                </div>
                <div class="span-2">
                    <label for="reducedDepositAmount_${trackId}" class="tooltip-header">פקדון מופחת (₪)<span class="tooltip-text">סכום ההפחתה מהפיקדון. כל 50,000₪ הפחתה מהפיקדון מוסיפים 500₪ לדמי האחזקה החודשיים.</span></label>
                    <div class="spinner-control">
                        <button type="button" class="spinner-btn stepper-btn" data-step-dir="up" data-track-id="${trackId}">+</button>
                        <input type="text" id="reducedDepositAmount_${trackId}" data-track-id="${trackId}" value="0" class="expense" inputmode="decimal">
                        <button type="button" class="spinner-btn stepper-btn" data-step-dir="down" data-track-id="${trackId}">-</button>
                    </div>
                </div>
                <div class="span-4">
                    <label for="depositAmount_${trackId}">סכום פיקדון (₪)</label>
                    <div class="spinner-control">
                        <button class="spinner-btn" data-step-dir="up" data-target="depositAmount_${trackId}">+</button>
                        <input type="text" id="depositAmount_${trackId}" data-track-id="${trackId}" data-base-value="1000000" value="1000000" class="income" inputmode="decimal">
                        <button class="spinner-btn" data-step-dir="down" data-target="depositAmount_${trackId}">-</button>
                    </div>
                </div>
                <div class="span-2"><label for="depositDepreciationPct_${trackId}">פחת פיקדון שנתי (%)</label><div class="spinner-control"><button class="spinner-btn" data-step-dir="up" data-target="depositDepreciationPct_${trackId}">+</button><input type="text" id="depositDepreciationPct_${trackId}" value="3" class="expense" inputmode="decimal"><button class="spinner-btn" data-step-dir="down" data-target="depositDepreciationPct_${trackId}">-</button></div></div>
                <div class="span-2"><label for="depositRefundPct_${trackId}">אחוז החזר מינימלי (%)</label><div class="spinner-control"><button class="spinner-btn" data-step-dir="up" data-target="depositRefundPct_${trackId}">+</button><input type="text" id="depositRefundPct_${trackId}" value="80" class="income" inputmode="decimal"><button class="spinner-btn" data-step-dir="down" data-target="depositRefundPct_${trackId}">-</button></div></div>`;
        } else if (mode === 'entrance_fee') {
            html += `
                <div class="span-3"><label for="baseWithEntranceFee_${trackId}">דמי אחזקה (₪)</label><div class="spinner-control"><button class="spinner-btn" data-step-dir="up" data-target="baseWithEntranceFee_${trackId}">+</button><input type="text" id="baseWithEntranceFee_${trackId}" value="9500" class="expense" inputmode="decimal"><button class="spinner-btn" data-step-dir="down" data-target="baseWithEntranceFee_${trackId}">-</button></div></div>
                <div class="span-3"><label for="entranceFeeAmount_${trackId}">סכום דמי כניסה (₪)</label><div class="spinner-control"><button class="spinner-btn" data-step-dir="up" data-target="entranceFeeAmount_${trackId}">+</button><input type="text" id="entranceFeeAmount_${trackId}" value="450000" class="income" inputmode="decimal"><button class="spinner-btn" data-step-dir="down" data-target="entranceFeeAmount_${trackId}">-</button></div></div>
                <div class="span-3"><label for="entranceFeeDepreciationYears_${trackId}">משך הפחת (שנים)</label><div class="spinner-control"><button class="spinner-btn" data-step-dir="up" data-target="entranceFeeDepreciationYears_${trackId}">+</button><input type="text" id="entranceFeeDepreciationYears_${trackId}" value="5" class="expense" inputmode="decimal"><button class="spinner-btn" data-step-dir="down" data-target="entranceFeeDepreciationYears_${trackId}">-</button></div></div>
                <div class="span-3"><label for="entranceFeeDepreciationRateMonthly_${trackId}">פחת חודשי (מחושב)</label><input type="text" id="entranceFeeDepreciationRateMonthly_${trackId}" value="" class="expense" inputmode="decimal" readonly style="background-color: var(--bg); cursor: not-allowed;"></div>`;
        } else { // none
            html += `<div class="span-3"><label for="baseNoDeposit_${trackId}">דמי אחזקה (₪)</label><div class="spinner-control"><button class="spinner-btn" data-step-dir="up" data-target="baseNoDeposit_${trackId}">+</button><input type="text" id="baseNoDeposit_${trackId}" value="14000" class="expense" inputmode="decimal"><button class="spinner-btn" data-step-dir="down" data-target="baseNoDeposit_${trackId}">-</button></div></div>`;
        }
        html += '</div>';
        body.innerHTML = html;
        setupNumberFormattingForContainer(body);
        if (mode === 'entrance_fee') {
            updateCalculatedEntranceFeeRate(trackId);
        }
    }
    
    function renderResults() {
        const container = $('resultsTableContainer');
        const targetYear = parseFloat($('yearSlider').value);
        const targetMonths = Math.round(targetYear * 12);
        $('yearSliderLabel').textContent = `הצג תוצאות לאחר: ${targetYear} שנים`;
        
        const pricingModeMap = {
            'deposit': 'עם פיקדון',
            'entrance_fee': 'דמי כניסה',
            'none': 'ללא'
        };
        
        let table = `<table class="results-table"><thead><tr>
            <th>שם החברה-סוג החדר</th>
            <th>סוג מסלול</th>
            <th>סה"כ חודשים (עצמאי / סיעודי)</th>
            <th class="tooltip-header">עלות מצטברת כוללת (₪)<span class="tooltip-text">סך כל ההוצאות (מחייה, דמי אחזקה ותוספת סיעוד) בתוספת הפחת על הפיקדון/דמי כניסה. מציג את העלות הכלכלית המלאה.</span></th>
            <th class="tooltip-header">תשלום לספק (₪)<span class="tooltip-text">סך העלות הכלכלית לספק, כולל דמי אחזקה, תוספת סיעודית, ופחת על הפיקדון או דמי הכניסה.</span></th>
            <th class="tooltip-header">יתרת הון בסיום (₪)<span class="tooltip-text">ההון הנזיל שנותר בחשבון בנקודת הזמן שנבחרה, לאחר כל ההכנסות וההוצאות, ובתוספת התשואה על הכסף.</span></th>
            <th class="tooltip-header">החזר צפוי (₪)<span class="tooltip-text">הסכום שיתקבל חזרה מהפיקדון או דמי הכניסה בנקודת הזמן שנבחרה, בהתחשב בתנאי הפחת של המסלול.</span></th>
            <th>תזרים חודשי ראשון (₪)<div style="font-size: 0.8em; color: var(--muted); font-weight: normal;">הכנסות / הוצאות / יתרה</div></th>
        </tr></thead><tbody>`;

        simulationResults.forEach(result => {
            const rSummary = result.summary;
            let displayMonths, years, months, durationNote, indMonths, nursMonths, finalCash, refundEnd, cumulativeProviderCost, rowClass = '', totalEconomicCost = 0;

            if (result.monthlyLog.length === 0) {
                rowClass = 'insolvent';
                displayMonths = 0;
                durationNote = '<div class="note danger">לא מספיק הון להתחלה</div>';
                indMonths = 0;
                nursMonths = 0;
                finalCash = 0;
                refundEnd = 0;
                cumulativeProviderCost = 0;
                totalEconomicCost = 0;
            } else {
                const ran_out_of_money = !rSummary.maxedOut;
                const show_as_insolvent = ran_out_of_money && rSummary.totalMonths < targetMonths;

                if (show_as_insolvent) {
                    rowClass = 'insolvent';
                    const lastLog = result.monthlyLog[result.monthlyLog.length - 1];
                    displayMonths = lastLog.month;
                    indMonths = lastLog.independentMonths;
                    nursMonths = lastLog.nursingMonths;
                    finalCash = 0;
                    refundEnd = lastLog.refund;
                    
                    const cumulativeCost = result.monthlyLog.reduce((sum, log) => sum + (log.totalCost || 0), 0);
                    cumulativeProviderCost = result.monthlyLog.reduce((sum, log) => sum + (log.providerEconomicCost || 0), 0);
                    const cumulativeProviderCashCost = result.monthlyLog.reduce((sum, log) => sum + (log.providerCost || 0), 0);
                    const cumulativeLivingCost = cumulativeCost - cumulativeProviderCashCost;
                    totalEconomicCost = cumulativeProviderCost + cumulativeLivingCost;

                    years = Math.floor(displayMonths / 12);
                    months = displayMonths % 12;
                    durationNote = `<div class="note danger">ההון אזל לאחר ${years} שנים ו־${months} חודשים</div>`;
                } else {
                    const cappedTargetMonths = Math.min(targetMonths, rSummary.totalMonths);
                    const relevantLogs = result.monthlyLog.slice(0, cappedTargetMonths);
                    
                    if (relevantLogs.length > 0) {
                        const lastLog = relevantLogs[relevantLogs.length - 1];
                        displayMonths = lastLog.month;
                        indMonths = lastLog.independentMonths;
                        nursMonths = lastLog.nursingMonths;
                        finalCash = lastLog.cash;
                        refundEnd = lastLog.refund;

                        const cumulativeCost = relevantLogs.reduce((sum, log) => sum + (log.totalCost || 0), 0);
                        cumulativeProviderCost = relevantLogs.reduce((sum, log) => sum + (log.providerEconomicCost || 0), 0);
                        const cumulativeProviderCashCost = relevantLogs.reduce((sum, log) => sum + (log.providerCost || 0), 0);
                        const cumulativeLivingCost = cumulativeCost - cumulativeProviderCashCost;
                        totalEconomicCost = cumulativeProviderCost + cumulativeLivingCost;
                        
                        years = Math.floor(displayMonths / 12);
                        months = displayMonths % 12;
                        durationNote = `<div class="note">${years} שנים ו־${months} חודשים</div>`;
                    } else {
                        displayMonths = 0; indMonths = 0; nursMonths = 0; finalCash = 0; refundEnd = 0; cumulativeProviderCost = 0; totalEconomicCost = 0;
                        durationNote = '<div class="note">---</div>';
                    }
                }
            }
            
            const pricingModeText = pricingModeMap[rSummary.pricingMode] || rSummary.pricingMode;
            const firstMonthParams = readAllInputsForTrack(rSummary.trackId);
            const baseCost = (firstMonthParams.pricingMode === 'deposit') ? firstMonthParams.baseWithDeposit : (firstMonthParams.pricingMode === 'entrance_fee') ? firstMonthParams.baseWithEntranceFee : firstMonthParams.baseNoDeposit;
            const livingExpenses = firstMonthParams.monthlyLivingExpenses;
            const fixedIncome = firstMonthParams.monthlyIncome;
            const rentIncome = (firstMonthParams.scenario === 'rent') ? Math.max(0, (firstMonthParams.rentGross * (1 - firstMonthParams.rentTaxPct) * (1 - firstMonthParams.vacancyPct)) - (firstMonthParams.annualMaintenance / 12)) : 0;
            const indNet = (fixedIncome + rentIncome) - (baseCost + livingExpenses);

            const trackParams = readAllInputsForTrack(rSummary.trackId);
            let tooltipDetails = '';

            if (trackParams) {
                if (trackParams.pricingMode === 'deposit') {
                    tooltipDetails = `
                        <div style="font-weight: bold; margin-bottom: 5px; color: var(--accent);">פרטי מסלול פיקדון</div>
                        <div>דמי אחזקה: <b>${fmt(trackParams.baseWithDeposit)} ₪</b></div>
                        <div>סכום פיקדון: <b>${fmt(trackParams.depositAmount)} ₪</b></div>
                        <div>פחת שנתי: <b>${trackParams.depositDepreciationPct * 100}%</b></div>
                        <div>החזר מינימלי: <b>${trackParams.depositRefundPct * 100}%</b></div>
                    `;
                } else if (trackParams.pricingMode === 'entrance_fee') {
                    const rateInput = $(`entranceFeeDepreciationRateMonthly_${trackParams.id}`);
                    const calculatedRateDisplay = rateInput ? rateInput.value : 'N/A';

                    tooltipDetails = `
                        <div style="font-weight: bold; margin-bottom: 5px; color: var(--accent);">פרטי מסלול דמי כניסה</div>
                        <div>דמי אחזקה: <b>${fmt(trackParams.baseWithEntranceFee)} ₪</b></div>
                        <div>דמי כניסה: <b>${fmt(trackParams.entranceFeeAmount)} ₪</b></div>
                        <div>משך הפחת: <b>${trackParams.entranceFeeDepreciationYears} שנים</b></div>
                        <div>פחת חודשי: <b>${calculatedRateDisplay}</b></div>
                    `;
                } else if (trackParams.pricingMode === 'none') {
                    tooltipDetails = `
                        <div style="font-weight: bold; margin-bottom: 5px; color: var(--accent);">פרטי מסלול שכירות</div>
                        <div>דמי אחזקה: <b>${fmt(trackParams.baseNoDeposit)} ₪</b></div>
                    `;
                }
            }

            table += `<tr class="${rowClass}">
                <td>
                    <span class="tooltip-header">${rSummary.trackName}
                        <span class="tooltip-text" style="width: auto; white-space: nowrap; text-align: right; line-height: 1.6;">
                            ${tooltipDetails}
                        </span>
                    </span>
                </td>
                <td>${pricingModeText}</td>
                <td><b>${fmt(displayMonths)} (${fmt(indMonths)} / ${fmt(nursMonths)})</b>${durationNote || ''}</td>
                <td>${fmt(totalEconomicCost)}</td>
                <td>${fmt(cumulativeProviderCost)}</td>
                <td>${fmt(finalCash)}</td>
                <td>${fmt(refundEnd)}</td>
                <td>
                    <span class="income">${fmt(fixedIncome + rentIncome)}</span> /
                    <span class="expense">${fmt(baseCost + livingExpenses)}</span> /
                    <b class="${indNet >= 0 ? 'ok' : 'danger'}">${fmt(indNet)}</b>
                </td>
            </tr>`;
        });

        table += '</tbody></table>';
        container.innerHTML = table;
    }

    // --- Input Reading ---
    function readAllInputsForTrack(trackId) {
        const trackCard = document.querySelector(`.track-card[data-track-id='${trackId}']`);
        if (!trackCard) return null;
        
        const pMode = $(`pricingMode_${trackId}`).value;
        const trackName = $(`trackName_${trackId}`).value;

        const trackParams = {
            id: trackId,
            trackName: trackName,
            pricingMode: pMode,
            baseWithDeposit: pMode === 'deposit' ? unformat($(`baseWithDeposit_${trackId}`).value) : 0,
            baseWithEntranceFee: pMode === 'entrance_fee' ? unformat($(`baseWithEntranceFee_${trackId}`).value) : 0,
            baseNoDeposit: pMode === 'none' ? unformat($(`baseNoDeposit_${trackId}`).value) : 0,
            depositAmount: pMode === 'deposit' ? unformat($(`depositAmount_${trackId}`).value) : 0,
            depositDepreciationPct: pMode === 'deposit' ? unformat($(`depositDepreciationPct_${trackId}`).value) / 100 : 0,
            depositRefundPct: pMode === 'deposit' ? unformat($(`depositRefundPct_${trackId}`).value) / 100 : 0,
            entranceFeeAmount: pMode === 'entrance_fee' ? unformat($(`entranceFeeAmount_${trackId}`).value) : 0,
            entranceFeeDepreciationRateMonthly: pMode === 'entrance_fee' ? (parseFloat($(`entranceFeeDepreciationRateMonthly_${trackId}`).value) || 0) / 100 : 0,
            entranceFeeDepreciationYears: pMode === 'entrance_fee' ? unformat($(`entranceFeeDepreciationYears_${trackId}`).value) : 0,
        };
        
        const commonParams = {
            isNursing: $('isNursing').checked,
            initCash: unformat($('initCash').value),
            monthlyIncome: unformat($('monthlyIncome').value),
            monthlyLivingExpenses: unformat($('monthlyLivingExpenses').value),
            oneTimeCosts: unformat($('oneTimeCosts').value),
            annualReturn: unformat($('annualReturn').value) / 100,
            annualInflation: unformat($('annualInflation').value) / 100,
            maxYears: unformat($('maxYears').value),
            monthsIndependent: unformat($('monthsIndependent').value),
            nursingAddon: unformat($('nursingAddon').value),
            nursingAllowance: unformat($('nursingAllowance').value),
            scenario: $('assetScenarioSelect').value,
            salePrice: unformat($('salePrice').value),
            saleCostsPct: unformat($('saleCostsPct').value) / 100,
            rentGross: unformat($('rentGross').value),
            rentTaxPct: unformat($('rentTaxPct').value) / 100,
            vacancyPct: unformat($('vacancyPct').value) / 100,
            annualMaintenance: unformat($('annualMaintenance').value),
        };

        return { ...commonParams, ...trackParams };
    }

    // --- Import / Export ---
    function collectDataForExport() {
        const data = {
            common: {},
            tracks: []
        };
        
        // Collect common inputs
        const commonInputs = document.querySelectorAll('#commonInputsCard input, #commonInputsCard select');
        commonInputs.forEach(input => {
            if (input.type === 'checkbox') {
                data.common[input.id] = input.checked;
            } else {
                data.common[input.id] = input.value;
            }
        });

        // Collect tracks
        document.querySelectorAll('.track-card').forEach(card => {
            const trackData = {};
            card.querySelectorAll('input, select').forEach(input => {
                const key = input.id.split('_')[0]; // e.g., 'trackName' from 'trackName_123'
                trackData[key] = input.value;
                if(input.dataset.baseValue) {
                    trackData[key + '_base'] = input.dataset.baseValue;
                }
            });
            data.tracks.push(trackData);
        });
        
        return data;
    }

    function handleExport() {
        try {
            const data = collectDataForExport();
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = 'calculator-data.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        } catch (error) {
            console.error("Error during export:", error);
            alert("שגיאה בעת ייצוא הנתונים.");
        }
    }
    
    function applyImportedData(data) {
        // Apply common inputs
        for (const id in data.common) {
            const input = $(id);
            if (input) {
                if (input.type === 'checkbox') {
                    input.checked = data.common[id];
                } else {
                    input.value = data.common[id] || '';
                }
                input.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
        
        // Clear existing tracks
        $('tracksContainer').innerHTML = '';
        tracks = [];

        // Apply tracks
        data.tracks.forEach(trackData => {
            handleAddTrack(); 
            const newTrack = tracks[tracks.length - 1];
            const trackId = newTrack.id;
            const trackCard = document.querySelector(`.track-card[data-track-id='${trackId}']`);

            const modeSelect = $(`pricingMode_${trackId}`);
            modeSelect.value = trackData.pricingMode;
            updateTrackBody(trackId);

            for (const key in trackData) {
                const isBaseValue = key.endsWith('_base');
                const baseKey = isBaseValue ? key.slice(0, -5) : key;
                const newId = `${baseKey}_${trackId}`;
                const input = $(newId);
                if (input) {
                    if (isBaseValue) {
                        input.dataset.baseValue = trackData[key];
                    } else {
                        input.value = trackData[key] || '';
                    }
                }
            }

            // This is crucial: apply number formatting to all the newly loaded values.
            if (trackCard) {
                setupNumberFormattingForContainer(trackCard);
            }
            
            // Now, trigger the calculation logic by simulating user input.
            // This is more robust than calling the functions directly as it uses the existing event pathways.
            if (modeSelect.value === 'deposit') {
                const reducedDepositInput = $(`reducedDepositAmount_${trackId}`);
                if (reducedDepositInput) {
                    reducedDepositInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            } else if (modeSelect.value === 'entrance_fee') {
                const yearsInput = $(`entranceFeeDepreciationYears_${trackId}`);
                if (yearsInput) {
                    yearsInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
        });

        hideResultsModal();
        alert('הנתונים יובאו בהצלחה!');
    }

    function handleImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (data && data.common && data.tracks) {
                    applyImportedData(data);
                } else {
                    throw new Error("Invalid data structure");
                }
            } catch (error) {
                console.error("Error during import:", error);
                alert("שגיאה בקריאת הקובץ. ודא שזהו קובץ נתונים תקין.");
            } finally {
                event.target.value = null;
            }
        };
        reader.readAsText(file);
    }

    // --- Event Handlers & Setup ---
    function handleAddTrack() {
        const newTrack = {
            id: Date.now(),
            name: `מסלול ${tracks.length + 1}`,
            pricingMode: 'deposit'
        };
        tracks.push(newTrack);
        renderTrackCard(newTrack);
    }
    
    function handleCalculate() {
        const trackCards = document.querySelectorAll('.track-card');
        if (trackCards.length === 0) {
            alert('יש להוסיף לפחות מסלול אחד להשוואה.');
            return;
        }

        simulationResults = Array.from(trackCards).map(card => {
            const trackId = card.dataset.trackId;
            const params = readAllInputsForTrack(trackId);
            return simulate(params);
        });
        
        setupYearSlider();
        renderResults();
        showResultsModal();
    }
    
    function setupYearSlider() {
        const slider = $('yearSlider');
        const datalist = $('yearTicks');
        const maxYears = Math.max(0.5, unformat($('maxYears').value) || 15, ...simulationResults.map(r => Math.ceil(r.summary.totalMonths / 12)));
        
        slider.min = 0.5;
        slider.step = 0.5;
        slider.max = maxYears;
        slider.value = maxYears;
        $('sliderMinLabel').textContent = 'חצי שנה';
        $('sliderMaxLabel').textContent = `שנה ${maxYears}`;

        datalist.innerHTML = '';
        for (let i = 1; i <= Math.floor(maxYears); i++) {
            const option = document.createElement('option');
            option.value = i;
            datalist.appendChild(option);
        }

        slider.oninput = renderResults;
    }

    // --- Utilities ---
    const formatNumber = (v) => {
        if (v === '' || v === null || v === undefined) return '';
        const clean = v.toString().replace(/[^0-9.]/g, '');
        if (clean === '') return '';
        const parts = clean.split('.');
        const integerPart = new Intl.NumberFormat('he-IL').format(Number(parts[0]));
        return parts.length > 1 ? `${integerPart}.${parts[1]}` : integerPart;
    };
    
    function setupNumberFormattingForContainer(container) {
        container.querySelectorAll('input[type="text"][inputmode="decimal"]').forEach(input => {
            input.value = formatNumber(input.value);
            input.addEventListener('input', (e) => {
                const { target } = e;
                const originalValue = target.value;
                const cursorPos = target.selectionStart;
                const digitsToRight = (originalValue.substring(cursorPos).match(/\d/g) || []).length;
                
                const formattedValue = formatNumber(originalValue);
                if (originalValue === formattedValue) return;
                target.value = formattedValue;
                
                let newCursorPos = formattedValue.length;
                if (digitsToRight > 0) {
                    let digitsCounted = 0;
                    for (let i = formattedValue.length - 1; i >= 0; i--) {
                        if (/\d/.test(formattedValue[i])) digitsCounted++;
                        if (digitsCounted === digitsToRight) {
                            newCursorPos = i;
                            break;
                        }
                    }
                }
                target.setSelectionRange(newCursorPos, newCursorPos);
            });
        });
    }

    function updateDepositReduction(trackId) {
        const reducedDepositInput = $(`reducedDepositAmount_${trackId}`);
        const maintenanceInput = $(`baseWithDeposit_${trackId}`);
        const depositInput = $(`depositAmount_${trackId}`);

        if (!reducedDepositInput || !maintenanceInput || !depositInput) return;
        
        const baseMaintenance = unformat(maintenanceInput.dataset.baseValue);
        const baseDeposit = unformat(depositInput.dataset.baseValue);
        let reducedAmount = unformat(reducedDepositInput.value);

        // Cap reduction amount if it would result in negative deposit
        const maxReduction = baseDeposit;
        if (reducedAmount > maxReduction) {
            reducedAmount = maxReduction;
            reducedDepositInput.value = formatNumber(reducedAmount);
        }
        
        const maintenanceIncrease = (reducedAmount / 50000) * 500;
        const newMaintenance = baseMaintenance + maintenanceIncrease;
        const newDeposit = baseDeposit - reducedAmount;
        
        maintenanceInput.value = formatNumber(Math.max(0, newMaintenance));
        depositInput.value = formatNumber(Math.max(0, newDeposit));
    }

    function getStepForInput(input) {
        const id = input.id || '';
        if (id.includes('Pct') || id.includes('Return') || id.includes('Inflation')) {
            return 0.5;
        }
        if (id.toLowerCase().includes('years')) return 1;
        if (id.includes('monthsIndependent')) return 6;
        
        const value = Math.abs(unformat(input.value));
        if (value >= 1000000) return 100000;
        if (value >= 100000) return 10000;
        if (value >= 10000) return 1000;
        return 500;
    }

    function isSigned(input) {
        return false; // No negative values allowed for now
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => { 
        // Initial setup for common inputs
        setupNumberFormattingForContainer(document.body);

        // --- New Spinner Logic ---
        document.addEventListener('click', (e) => {
            if (!e.target.matches('.spinner-btn:not(.stepper-btn)')) return;

            const { stepDir, target: targetId } = e.target.dataset;
            const targetInput = $(targetId);
            if (!targetInput) return;

            let currentValue = unformat(targetInput.value);
            const step = getStepForInput(targetInput);
            const multiplier = stepDir === 'up' ? 1 : -1;

            let newValue = currentValue + (step * multiplier);
            
            if (!isSigned(targetInput)) {
                newValue = Math.max(0, newValue);
            }

            targetInput.value = formatNumber(newValue);

            targetInput.dispatchEvent(new Event('input', { bubbles: true }));
            targetInput.dispatchEvent(new Event('change', { bubbles: true }));
        });
        
        $('isNursing').addEventListener('change', (e) => {
            $('nursingFieldsRow').style.display = e.target.checked ? 'grid' : 'none';
        });

        $('assetScenarioSelect').addEventListener('change', (e) => {
            const scenario = e.target.value;
            $('sellBlock').style.display = scenario === 'sell' ? 'block' : 'none';
            $('rentBlock').style.display = scenario === 'rent' ? 'block' : 'none';
        });

        // Track management
        $('addTrackBtn').addEventListener('click', handleAddTrack);
        $('tracksContainer').addEventListener('click', (e) => {
            if (e.target.dataset.removeTrackId) {
                const trackId = e.target.dataset.removeTrackId;
                tracks = tracks.filter(t => t.id != trackId);
                document.querySelector(`.track-card[data-track-id='${trackId}']`).remove();
            } else if (e.target.classList.contains('stepper-btn')) {
                const { trackId, stepDir } = e.target.dataset;
                const reducedDepositInput = $(`reducedDepositAmount_${trackId}`);
                const depositInput = $(`depositAmount_${trackId}`);

                const currentReduction = unformat(reducedDepositInput.value);
                const step = 50000;
                const newReduction = currentReduction + (stepDir === 'up' ? step : -step);
                
                if (newReduction < 0) return;

                const baseDeposit = unformat(depositInput.dataset.baseValue);
                if (stepDir === 'up' && (baseDeposit - newReduction) < 0) {
                    alert('לא ניתן להפחית יותר מסכום הפיקדון המקורי.');
                    return;
                }
                
                reducedDepositInput.value = formatNumber(newReduction);
                updateDepositReduction(trackId);
            }
        });

        $('tracksContainer').addEventListener('change', (e) => {
            if (e.target.id.startsWith('pricingMode_')) {
                const trackId = e.target.id.split('_')[1];
                updateTrackBody(trackId);
            }
        });

        $('tracksContainer').addEventListener('input', (e) => {
            if (e.target.id.startsWith('entranceFeeDepreciationYears_') || e.target.id.startsWith('entranceFeeAmount_')) {
                const trackId = e.target.id.split('_')[1];
                updateCalculatedEntranceFeeRate(trackId);
            } else if (e.target.id.startsWith('reducedDepositAmount_')) {
                const trackId = e.target.dataset.trackId;
                updateDepositReduction(trackId);
            }

            const trackId = e.target.dataset.trackId;
            if (!trackId) return;

            const isMaintenance = e.target.id.startsWith('baseWithDeposit_');
            const isDeposit = e.target.id.startsWith('depositAmount_');
            
            if (isMaintenance || isDeposit) {
                // User is manually editing a base value, so reset the reduction.
                e.target.dataset.baseValue = unformat(e.target.value);
                const reducedDepositInput = $(`reducedDepositAmount_${trackId}`);
                if (reducedDepositInput.value !== '0' && reducedDepositInput.value !== '') {
                    reducedDepositInput.value = formatNumber('0');
                    
                    // After resetting reduction, recalculate to bring fields back to their new base values
                    updateDepositReduction(trackId);

                    // Then, update the *other* field's base value to its current value.
                    if (isMaintenance) {
                        const depositInput = $(`depositAmount_${trackId}`);
                        depositInput.dataset.baseValue = unformat(depositInput.value);
                    } else {
                        const maintenanceInput = $(`baseWithDeposit_${trackId}`);
                        maintenanceInput.dataset.baseValue = unformat(maintenanceInput.value);
                    }
                }
            }
        });

        // Calculation
        $('calculateBtn').addEventListener('click', handleCalculate);
        
        // Import / Export
        $('importBtn').addEventListener('click', () => $('importFile').click());
        $('exportBtn').addEventListener('click', handleExport);
        $('importFile').addEventListener('change', handleImport);

        // Modal Closing
        $('closeModalBtn').addEventListener('click', hideResultsModal);
        $('resultsModal').addEventListener('click', (e) => {
            if (e.target === $('resultsModal')) {
                hideResultsModal();
            }
        });

        // Add one track by default
        handleAddTrack();
    });
  </script>
</body>
</html>