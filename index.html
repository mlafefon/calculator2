<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מחשבון השוואת מסלולי דיור מוגן</title>
  <style>
    :root {
      --bg: #0f172a;          /* slate-900 */
      --panel: #1e293b;       /* slate-800 */
      --muted: #94a3b8;       /* slate-400 */
      --text: #e5e7eb;        /* gray-200 */
      --accent: #22d3ee;      /* cyan-400 */
      --accent-2: #34d399;    /* emerald-400 */
      --danger: #fb7185;      /* rose-400 */
      --warn: #f59e0b;        /* amber-500 */
      --ok: #10b981;          /* emerald-500 */
      --card: #111827;
      --input: #1e293b;
      --border: #334155;      /* slate-700 */
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text); font-family: system-ui, Segoe UI, Arial, "Noto Sans Hebrew", sans-serif; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 2.25rem; margin: 0 0 8px; text-align: center; color: var(--accent); }
    h2 { font-size: 1.5rem; margin: 24px 0 16px; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 8px; }
    h3 { font-size: 1.1rem; color: var(--muted); margin: 16px 0 8px; }
    p.subtitle { color: var(--muted); margin: 0 0 24px; text-align: center; max-width: 700px; margin-left: auto; margin-right: auto; line-height: 1.6; }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 24px; }
    .span-12 { grid-column: span 12; }
    .span-8 { grid-column: span 8; }
    .span-6 { grid-column: span 6; }
    .span-4 { grid-column: span 4; }
    .span-3 { grid-column: span 3; }
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; margin-bottom: 16px; align-items: end; }
    label { font-size: 0.9rem; color: var(--muted); display: block; margin-bottom: 6px; }
    label .help-icon { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; border: 1px solid var(--muted); color: var(--muted); font-size: 11px; font-weight: bold; margin-right: 6px; cursor: pointer; user-select: none; transition: all 0.2s; }
    label .help-icon:hover { background: var(--accent); color: var(--card); border-color: var(--accent); }
    input, select { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--input); color: var(--text); font-size: 0.95rem; transition: border-color 0.2s, box-shadow 0.2s; }
    input:focus, select:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(34,211,238,.15); }
    input.income, select.income { color: var(--ok); }
    input.expense, select.expense { color: var(--danger); }
    input[type="checkbox"] { width: auto; accent-color: var(--accent); }
    .btn { cursor: pointer; background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #001018; border: none; padding: 12px 16px; border-radius: 12px; font-weight: 700; transition: transform 0.2s, box-shadow 0.2s; }
    .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .btn.secondary { background: transparent; color: var(--text); border: 1px solid var(--border); }
    .btn.secondary:hover:not(:disabled) { background: var(--panel); border-color: var(--accent); }
    .btn.danger { background: var(--danger); color: var(--text); border: none; }
    .btn.danger:hover:not(:disabled) { background: #f43f5e; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .note { font-size: .85rem; color: var(--muted); }
    .note.danger { color: var(--danger); font-weight: 500; }
    .inline-row { display: flex; align-items: center; gap: 8px; }
    .hr { border-top: 1px dashed var(--border); margin: 24px 0; }
    
    #tracksContainer .track-card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px; position: relative; }
    .track-header { display: flex; gap: 16px; margin-bottom: 16px; align-items: center; }
    .track-header .form-group { flex-grow: 1; }
    
    #resultsSection { display: none; }
    .results-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    .results-table th, .results-table td { padding: 12px; text-align: center; border-bottom: 1px solid var(--border); }
    .results-table th { color: var(--accent); font-size: 0.9rem; }
    .results-table td { font-size: 1rem; }
    .results-table tr:last-child td { border-bottom: none; }
    .results-table td:first-child { font-weight: bold; text-align: right; }
    .results-table tr.insolvent { background-color: rgba(251, 113, 133, 0.1); }
    .breakdown-cell { font-size: .8rem; text-align: right; padding: 4px; }
    .breakdown-cell table { width: 100%; }
    .breakdown-cell td:last-child { text-align: left; direction: ltr; }
    
    #sliderGroup { margin-bottom: 24px; padding: 16px; background: var(--panel); border-radius: 12px; }
    #yearSlider { width: 100%; accent-color: var(--accent); }
    #sliderLabels { display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--muted); margin-top: 8px; }

    .tradeoff-control { display: flex; align-items: stretch; gap: 4px; }
    .tradeoff-control > input { flex-grow: 1; }
    .stepper { display: flex; flex-direction: column; }
    .stepper-btn {
        flex-grow: 1;
        background: var(--border);
        color: var(--text);
        border: none;
        border-radius: 4px;
        cursor: pointer;
        padding: 0 8px;
        font-size: 1.2rem;
        line-height: 1;
        transition: background .2s;
    }
    .stepper-btn:hover { background: var(--accent); color: var(--bg); }
    .tradeoff-input {
        background: var(--input);
        color: var(--muted);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 4px 8px;
        font-size: .8rem;
        width: 60px;
        text-align: center;
        margin: 4px 0;
    }
    
    .tooltip-header {
      position: relative;
      cursor: help;
      text-decoration: underline;
      text-decoration-style: dotted;
    }
    .tooltip-text {
      visibility: hidden;
      width: 260px;
      background-color: var(--panel);
      color: var(--text);
      text-align: right;
      border-radius: 8px;
      padding: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      position: absolute;
      z-index: 9999;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-weight: normal;
      font-size: 0.85rem;
      line-height: 1.5;
      pointer-events: none;
    }
    .tooltip-header:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    .tooltip-text::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: var(--border) transparent transparent transparent;
    }

    @media (max-width: 900px) {
      .span-8, .span-6, .span-4, .span-3 { grid-column: span 12; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>מחשבון השוואת מסלולי דיור מוגן</h1>
    <p class="subtitle">הכלי מאפשר להשוות תרחישים פיננסיים שונים למגורים בדיור מוגן. התחילו בהזנת הנתונים הכלליים, הגדירו את מסלולי התמחור שברצונכם לבחון, ולבסוף השוו את התוצאות כדי לקבל החלטה מושכלת.</p>

    <!-- Step 1: Common Inputs -->
    <div class="card">
      <h2>שלב 1: נתונים כלליים ונכס</h2>
      <h3>פרמטרים פיננסיים</h3>
      <div class="row">
        <div class="span-3"><label for="initCash">הון נזיל התחלתי (₪)</label><input type="text" id="initCash" value="1500000" class="income" inputmode="decimal"/></div>
        <div class="span-3"><label for="monthlyIncome">הכנסה חודשית קבועה (₪)</label><input type="text" id="monthlyIncome" value="5500" class="income" inputmode="decimal"/></div>
        <div class="span-3"><label for="monthlyLivingExpenses">הוצאות מחייה חודשיות (₪)</label><input type="text" id="monthlyLivingExpenses" value="1500" class="expense" inputmode="decimal"/></div>
        <div class="span-3"><label for="oneTimeCosts">עלויות חד־פעמיות (₪)</label><input type="text" id="oneTimeCosts" value="0" class="expense" inputmode="decimal"/></div>
      </div>
      <div class="row">
        <div class="span-4"><label for="annualReturn">תשואת ריבית שנתית על היתרה (%)</label><input type="text" id="annualReturn" value="1" class="income" inputmode="decimal"/></div>
        <div class="span-4"><label for="annualInflation">קצב התייקרות שנתי (מדד) (%)</label><input type="text" id="annualInflation" value="2" class="expense" inputmode="decimal"/></div>
        <div class="span-4"><label for="maxYears">מגבלת סימולציה (שנים)</label><input type="text" id="maxYears" value="15" inputmode="decimal"/></div>
      </div>
      
      <div class="hr"></div>
      <h3>מצב סיעודי</h3>
      <div class="row">
        <div class="span-12"><label class="inline-row"><input id="isNursing" type="checkbox"/> להפעיל תרחיש מצב סיעודי</label></div>
      </div>
      <div class="row" id="nursingFieldsRow" style="display: none;">
        <div class="span-4"><label for="monthsIndependent">חודשים בתפקוד מלא</label><input type="text" id="monthsIndependent" value="60" inputmode="decimal"/></div>
        <div class="span-4"><label for="nursingAddon">תוספת חודשית במצב סיעודי (₪)</label><input type="text" id="nursingAddon" value="18000" class="expense" inputmode="decimal"/></div>
        <div class="span-4"><label for="nursingAllowance">גמלת סיעוד לקיזוז (₪/חודש)</label><input type="text" id="nursingAllowance" value="2000" class="income" inputmode="decimal"/></div>
      </div>

      <div class="hr"></div>
      <h3>תרחיש נכס</h3>
      <div class="row">
        <div class="span-4">
            <label for="assetScenarioSelect">בחר תרחיש עבור הדירה</label>
            <select id="assetScenarioSelect">
                <option value="sell">מכירת הדירה</option>
                <option value="rent" selected>השכרת הדירה</option>
                <option value="none">ללא שימוש בדירה</option>
            </select>
        </div>
      </div>
      <div id="sellBlock" style="display: none;">
        <div class="row">
          <div class="span-6"><label for="salePrice">מחיר מכירה (₪)</label><input type="text" id="salePrice" value="3000000" class="income" inputmode="decimal"/></div>
          <div class="span-6"><label for="saleCostsPct">עלויות עסקה (% מהמחיר)</label><input type="text" id="saleCostsPct" value="3" class="expense" inputmode="decimal"/></div>
        </div>
      </div>
      <div id="rentBlock">
        <div class="row">
          <div class="span-3"><label for="rentGross">שכ"ד חודשי ברוטו (₪)</label><input type="text" id="rentGross" value="7000" class="income" inputmode="decimal"/></div>
          <div class="span-3"><label for="rentTaxPct">מס על שכ"ד (%)</label><input type="text" id="rentTaxPct" value="10" class="expense" inputmode="decimal"/></div>
          <div class="span-3"><label for="vacancyPct">חודשים פנויים בשנה (%)</label><input type="text" id="vacancyPct" value="8" class="expense" inputmode="decimal"/></div>
          <div class="span-3"><label for="annualMaintenance">תחזוקה שנתית (₪)</label><input type="text" id="annualMaintenance" value="6000" class="expense" inputmode="decimal"/></div>
        </div>
      </div>
    </div>
    
    <!-- Step 2: Tracks Definition -->
    <div class="card">
        <h2>שלב 2: הגדרת מסלולים להשוואה</h2>
        <div id="tracksContainer"></div>
        <button id="addTrackBtn" class="btn secondary" style="margin-top: 16px;">+ הוסף מסלול חדש</button>
    </div>

    <!-- Calculate Button -->
    <button id="calculateBtn" class="btn" style="width: 100%; padding: 16px; font-size: 1.2rem; margin-top: 16px;">השווה מסלולים</button>

    <!-- Step 3: Results -->
    <div class="card" id="resultsSection">
        <h2>שלב 3: השוואת תוצאות</h2>

        <div id="sliderGroup">
            <label for="yearSlider" id="yearSliderLabel">הצג תוצאות לאחר:</label>
            <input type="range" id="yearSlider" list="yearTicks" min="0.5" max="15" value="15" step="0.5">
            <datalist id="yearTicks"></datalist>
            <div id="sliderLabels">
                <span id="sliderMinLabel">חצי שנה</span>
                <span id="sliderMaxLabel">שנה 15</span>
            </div>
        </div>

        <div id="resultsTableContainer"></div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const fmt = (n) => n === null || isNaN(n) ? '—' : new Intl.NumberFormat('he-IL').format(Math.round(n));
    const unformat = (val) => +(val || '0').toString().replace(/,/g, '');

    // --- State Management ---
    let tracks = [];
    let simulationResults = [];

    // --- Core Simulation Logic ---
    function simulate(p) {
        if (!p.isNursing) p.monthsIndependent = Infinity;

        let cash = p.initCash;
        if (p.scenario === 'sell') cash += Math.max(0, p.salePrice * (1 - p.saleCostsPct));
        
        let depositBook = 0;
        let entranceFeeBook = 0;

        if (p.pricingMode === 'deposit' && p.depositAmount > 0) {
            cash -= p.depositAmount;
            depositBook = p.depositAmount;
        }
        if (p.pricingMode === 'entrance_fee' && p.entranceFeeAmount > 0) {
            cash -= p.entranceFeeAmount;
            entranceFeeBook = p.entranceFeeAmount;
        }
        cash -= p.oneTimeCosts;

        const monthlyLog = [];

        if (cash < 0) {
             const summary = { totalMonths: 0, independentMonths: 0, nursingMonths: 0, refundEnd: p.pricingMode === 'deposit' ? p.depositAmount : p.entranceFeeAmount, finalCash: 0, trackName: p.trackName, maxedOut: false, pricingMode: p.pricingMode };
            return { summary, monthlyLog };
        }

        const monthlyReturn = Math.pow(1 + p.annualReturn, 1/12) - 1;
        const monthlyInfl = Math.pow(1 + p.annualInflation, 1/12) - 1;
        const maxMonths = p.maxYears > 0 ? p.maxYears * 12 : 50 * 12;

        const baseMonthlyCost = (t, mode) => {
            let base;
            if (mode === 'deposit') base = p.baseWithDeposit;
            else if (mode === 'entrance_fee') base = p.baseWithEntranceFee;
            else base = p.baseNoDeposit;
            return base * Math.pow(1 + monthlyInfl, t);
        };
        const nursingExtra = (t) => (Math.max(0, p.nursingAddon - p.nursingAllowance)) * Math.pow(1 + monthlyInfl, t);
        const rentNetPerMonth = (t) => {
            if (p.scenario !== 'rent') return 0;
            const gross = p.rentGross * Math.pow(1 + monthlyInfl, t);
            return Math.max(0, (gross * (1 - p.rentTaxPct) * (1 - p.vacancyPct)) - (p.annualMaintenance / 12));
        };
        const monthlyLivingCost = (t) => p.monthlyLivingExpenses * Math.pow(1 + monthlyInfl, t);

        let t = 0, independentMonths = 0, nursingMonths = 0, lastPositiveCash = cash;

        while (t < maxMonths) {
            cash *= (1 + monthlyReturn);
            const totalMonthlyCost = baseMonthlyCost(t, p.pricingMode) + ((t < p.monthsIndependent) ? 0 : nursingExtra(t)) + monthlyLivingCost(t);
            const income = p.monthlyIncome + rentNetPerMonth(t);
            cash += (income - totalMonthlyCost);
            
            if (p.pricingMode === 'deposit' && depositBook > 0 && t < (12 * 12)) {
                const monthlyDep = 1 - Math.pow(1 - (p.depositDepreciationPct || 0), 1/12);
                depositBook *= (1 - monthlyDep);
            }
            if (p.pricingMode === 'entrance_fee' && entranceFeeBook > 0 && t < (p.entranceFeeDepreciationYears * 12)) {
                const monthlyDepAmount = p.entranceFeeAmount * (p.entranceFeeDepreciationRateMonthly || 0);
                entranceFeeBook = Math.max(0, entranceFeeBook - monthlyDepAmount);
            }

            if (cash < 0) break;
            
            if (t < p.monthsIndependent) independentMonths++; else nursingMonths++;
            lastPositiveCash = cash;
            
            let refundCurrent = 0;
            if (p.pricingMode === 'deposit') {
                const floor = (p.depositAmount || 0) * (p.depositRefundPct || 0);
                refundCurrent = Math.max(0, Math.max(depositBook, floor));
            } else if (p.pricingMode === 'entrance_fee') {
                refundCurrent = entranceFeeBook;
            }
            
            monthlyLog.push({ month: t + 1, totalCost: totalMonthlyCost, cash: lastPositiveCash, refund: refundCurrent, independentMonths, nursingMonths });
            
            t++;
        }

        let refundEnd = 0;
        if (p.pricingMode === 'deposit') {
            const floor = (p.depositAmount || 0) * (p.depositRefundPct || 0);
            refundEnd = Math.max(0, Math.max(depositBook, floor));
        } else if (p.pricingMode === 'entrance_fee') {
            refundEnd = entranceFeeBook;
        }

        const summary = { totalMonths: t, independentMonths, nursingMonths, refundEnd, finalCash: lastPositiveCash, trackName: p.trackName, maxedOut: t >= maxMonths, pricingMode: p.pricingMode };
        return { summary, monthlyLog };
    }


    // --- UI Rendering ---
    function renderTrackCard(track) {
        const trackId = track.id;
        const card = document.createElement('div');
        card.className = 'track-card';
        card.dataset.trackId = trackId;
        card.innerHTML = `
            <div class="track-header">
                <div class="form-group"><label for="trackName_${trackId}">שם המסלול</label><input type="text" id="trackName_${trackId}" value="${track.name}" placeholder="לדוגמה: בית א׳ - מסלול פיקדון"></div>
                <div class="form-group"><label for="pricingMode_${trackId}">סוג המסלול</label>
                    <select id="pricingMode_${trackId}">
                        <option value="deposit" ${track.pricingMode === 'deposit' ? 'selected' : ''}>עם פיקדון</option>
                        <option value="entrance_fee" ${track.pricingMode === 'entrance_fee' ? 'selected' : ''}>דמי כניסה</option>
                        <option value="none" ${track.pricingMode === 'none' ? 'selected' : ''}>ללא</option>
                    </select>
                </div>
                <button class="btn danger" data-remove-track-id="${trackId}" style="align-self: flex-end;">הסר</button>
            </div>
            <div class="track-body"></div>`;

        $('tracksContainer').appendChild(card);
        updateTrackBody(trackId);
    }
    
    function updateTrackBody(trackId) {
        const card = document.querySelector(`.track-card[data-track-id='${trackId}']`);
        const body = card.querySelector('.track-body');
        const mode = card.querySelector(`#pricingMode_${trackId}`).value;

        let html = '<div class="row">';
        if (mode === 'deposit') {
            html += `
                <div class="span-3">
                    <label for="baseWithDeposit_${trackId}">דמי אחזקה (₪)</label>
                    <div class="tradeoff-control">
                        <input type="text" id="baseWithDeposit_${trackId}" data-track-id="${trackId}" data-base-value="9000" value="9000" class="expense" inputmode="decimal">
                        <input type="text" class="tradeoff-input" id="tradeoffAmount_${trackId}" value="0" readonly>
                        <div class="stepper">
                            <button type="button" class="stepper-btn" data-step-dir="up" data-track-id="${trackId}">+</button>
                            <button type="button" class="stepper-btn" data-step-dir="down" data-track-id="${trackId}">-</button>
                        </div>
                    </div>
                </div>
                <div class="span-3"><label for="depositAmount_${trackId}">סכום פיקדון (₪)</label><input type="text" id="depositAmount_${trackId}" data-track-id="${trackId}" data-base-value="1000000" value="1000000" class="income" inputmode="decimal"></div>
                <div class="span-3"><label for="depositDepreciationPct_${trackId}">פחת פיקדון שנתי (%)</label><input type="text" id="depositDepreciationPct_${trackId}" value="3" class="expense" inputmode="decimal"></div>
                <div class="span-3"><label for="depositRefundPct_${trackId}">אחוז החזר מינימלי (%)</label><input type="text" id="depositRefundPct_${trackId}" value="80" class="income" inputmode="decimal"></div>`;
        } else if (mode === 'entrance_fee') {
            html += `
                <div class="span-3"><label for="baseWithEntranceFee_${trackId}">דמי אחזקה (₪)</label><input type="text" id="baseWithEntranceFee_${trackId}" value="9500" class="expense" inputmode="decimal"></div>
                <div class="span-3"><label for="entranceFeeAmount_${trackId}">סכום דמי כניסה (₪)</label><input type="text" id="entranceFeeAmount_${trackId}" value="450000" class="income" inputmode="decimal"></div>
                <div class="span-3"><label for="entranceFeeDepreciationRateMonthly_${trackId}">פחת חודשי (%)</label><input type="text" id="entranceFeeDepreciationRateMonthly_${trackId}" value="1.5" class="expense" inputmode="decimal"></div>
                <div class="span-3"><label for="entranceFeeDepreciationYears_${trackId}">משך הפחת (שנים)</label><input type="text" id="entranceFeeDepreciationYears_${trackId}" value="5" class="expense" inputmode="decimal"></div>`;
        } else { // none
            html += `<div class="span-3"><label for="baseNoDeposit_${trackId}">דמי אחזקה (₪)</label><input type="text" id="baseNoDeposit_${trackId}" value="14000" class="expense" inputmode="decimal"></div>`;
        }
        html += '</div>';
        body.innerHTML = html;
        setupNumberFormattingForContainer(body);
    }
    
    function renderResults() {
        const container = $('resultsTableContainer');
        const targetYear = parseFloat($('yearSlider').value);
        const targetMonths = Math.round(targetYear * 12);
        $('yearSliderLabel').textContent = `הצג תוצאות לאחר: ${targetYear} שנים`;
        
        const pricingModeMap = {
            'deposit': 'עם פיקדון',
            'entrance_fee': 'דמי כניסה',
            'none': 'ללא'
        };
        
        let table = `<table class="results-table"><thead><tr>
            <th>מסלול</th>
            <th>סוג מסלול</th>
            <th>סה"כ חודשים (עצמאי / סיעודי)</th>
            <th class="tooltip-header">עלות מצטברת כוללת (₪)<span class="tooltip-text">סך כל ההוצאות החודשיות (דמי אחזקה + מחיה + תוספת סיעוד) שנצברו עד לנקודת הזמן שנבחרה.</span></th>
            <th class="tooltip-header">יתרת הון בסיום (₪)<span class="tooltip-text">ההון הנזיל שנותר בחשבון בנקודת הזמן שנבחרה, לאחר כל ההכנסות וההוצאות, ובתוספת התשואה על הכסף.</span></th>
            <th class="tooltip-header">החזר צפוי (₪)<span class="tooltip-text">הסכום שיתקבל חזרה מהפיקדון או דמי הכניסה בנקודת הזמן שנבחרה, בהתחשב בתנאי הפחת של המסלול.</span></th>
            <th>תזרים חודשי ראשון (₪)</th>
        </tr></thead><tbody>`;

        simulationResults.forEach(result => {
            const rSummary = result.summary;
            let displayMonths, years, months, durationNote, indMonths, nursMonths, finalCash, refundEnd, cumulativeCost, rowClass = '';

            if (result.monthlyLog.length === 0) {
                rowClass = 'insolvent';
                displayMonths = 0;
                durationNote = '<div class="note danger">לא מספיק הון להתחלה</div>';
                indMonths = 0;
                nursMonths = 0;
                finalCash = 0;
                refundEnd = 0;
                cumulativeCost = 0;
            } else {
                const ran_out_of_money = !rSummary.maxedOut;
                const show_as_insolvent = ran_out_of_money && rSummary.totalMonths < targetMonths;

                if (show_as_insolvent) {
                    rowClass = 'insolvent';
                    const lastLog = result.monthlyLog[result.monthlyLog.length - 1];
                    displayMonths = lastLog.month;
                    indMonths = lastLog.independentMonths;
                    nursMonths = lastLog.nursingMonths;
                    finalCash = 0;
                    refundEnd = lastLog.refund;
                    cumulativeCost = result.monthlyLog.reduce((sum, log) => sum + log.totalCost, 0);

                    years = Math.floor(displayMonths / 12);
                    months = displayMonths % 12;
                    durationNote = `<div class="note danger">ההון אזל לאחר ${years} שנים ו־${months} חודשים</div>`;
                } else {
                    const cappedTargetMonths = Math.min(targetMonths, rSummary.totalMonths);
                    const relevantLogs = result.monthlyLog.slice(0, cappedTargetMonths);
                    
                    if (relevantLogs.length > 0) {
                        const lastLog = relevantLogs[relevantLogs.length - 1];
                        displayMonths = lastLog.month;
                        indMonths = lastLog.independentMonths;
                        nursMonths = lastLog.nursingMonths;
                        finalCash = lastLog.cash;
                        refundEnd = lastLog.refund;
                        cumulativeCost = relevantLogs.reduce((sum, log) => sum + log.totalCost, 0);
                        
                        years = Math.floor(displayMonths / 12);
                        months = displayMonths % 12;
                        durationNote = `<div class="note">${years} שנים ו־${months} חודשים</div>`;
                    } else {
                        displayMonths = 0; indMonths = 0; nursMonths = 0; finalCash = 0; refundEnd = 0; cumulativeCost = 0;
                        durationNote = '<div class="note">---</div>';
                    }
                }
            }
            
            const pricingModeText = pricingModeMap[rSummary.pricingMode] || rSummary.pricingMode;
            const firstMonthParams = readAllInputsForTrack(rSummary.trackName);
            const baseCost = (firstMonthParams.pricingMode === 'deposit') ? firstMonthParams.baseWithDeposit : (firstMonthParams.pricingMode === 'entrance_fee') ? firstMonthParams.baseWithEntranceFee : firstMonthParams.baseNoDeposit;
            const livingExpenses = firstMonthParams.monthlyLivingExpenses;
            const fixedIncome = firstMonthParams.monthlyIncome;
            const rentIncome = (firstMonthParams.scenario === 'rent') ? Math.max(0, (firstMonthParams.rentGross * (1 - firstMonthParams.rentTaxPct) * (1 - firstMonthParams.vacancyPct)) - (firstMonthParams.annualMaintenance / 12)) : 0;
            const indNet = (fixedIncome + rentIncome) - (baseCost + livingExpenses);

            table += `<tr class="${rowClass}">
                <td>${rSummary.trackName}</td>
                <td>${pricingModeText}</td>
                <td><b>${fmt(displayMonths)} (${fmt(indMonths)} / ${fmt(nursMonths)})</b>${durationNote || ''}</td>
                <td>${fmt(cumulativeCost)}</td>
                <td>${fmt(finalCash)}</td>
                <td>${fmt(refundEnd)}</td>
                <td class="breakdown-cell">
                    <table>
                        <tr><td>הכנסות</td><td class="income">${fmt(fixedIncome + rentIncome)}</td></tr>
                        <tr><td>הוצאות</td><td class="expense">${fmt(baseCost + livingExpenses)}</td></tr>
                        <tr><td><b>יתרה</b></td><td class="${indNet >= 0 ? 'ok' : 'danger'}"><b>${fmt(indNet)}</b></td></tr>
                    </table>
                </td>
            </tr>`;
        });

        table += '</tbody></table>';
        container.innerHTML = table;
        $('resultsSection').style.display = 'block';
    }

    // --- Input Reading ---
    function readAllInputsForTrack(trackName) {
        const trackCard = Array.from(document.querySelectorAll('.track-card')).find(c => c.querySelector('input[id^="trackName"]').value === trackName);
        if (!trackCard) return null;
        const trackId = trackCard.dataset.trackId;
        const pMode = $(`pricingMode_${trackId}`).value;

        const trackParams = {
            trackName: trackName,
            pricingMode: pMode,
            baseWithDeposit: pMode === 'deposit' ? unformat($(`baseWithDeposit_${trackId}`).value) : 0,
            baseWithEntranceFee: pMode === 'entrance_fee' ? unformat($(`baseWithEntranceFee_${trackId}`).value) : 0,
            baseNoDeposit: pMode === 'none' ? unformat($(`baseNoDeposit_${trackId}`).value) : 0,
            depositAmount: pMode === 'deposit' ? unformat($(`depositAmount_${trackId}`).value) : 0,
            depositDepreciationPct: pMode === 'deposit' ? unformat($(`depositDepreciationPct_${trackId}`).value) / 100 : 0,
            depositRefundPct: pMode === 'deposit' ? unformat($(`depositRefundPct_${trackId}`).value) / 100 : 0,
            entranceFeeAmount: pMode === 'entrance_fee' ? unformat($(`entranceFeeAmount_${trackId}`).value) : 0,
            entranceFeeDepreciationRateMonthly: pMode === 'entrance_fee' ? unformat($(`entranceFeeDepreciationRateMonthly_${trackId}`).value) / 100 : 0,
            entranceFeeDepreciationYears: pMode === 'entrance_fee' ? unformat($(`entranceFeeDepreciationYears_${trackId}`).value) : 0,
        };
        
        const commonParams = {
            isNursing: $('isNursing').checked,
            initCash: unformat($('initCash').value),
            monthlyIncome: unformat($('monthlyIncome').value),
            monthlyLivingExpenses: unformat($('monthlyLivingExpenses').value),
            oneTimeCosts: unformat($('oneTimeCosts').value),
            annualReturn: unformat($('annualReturn').value) / 100,
            annualInflation: unformat($('annualInflation').value) / 100,
            maxYears: unformat($('maxYears').value),
            monthsIndependent: unformat($('monthsIndependent').value),
            nursingAddon: unformat($('nursingAddon').value),
            nursingAllowance: unformat($('nursingAllowance').value),
            scenario: $('assetScenarioSelect').value,
            salePrice: unformat($('salePrice').value),
            saleCostsPct: unformat($('saleCostsPct').value) / 100,
            rentGross: unformat($('rentGross').value),
            rentTaxPct: unformat($('rentTaxPct').value) / 100,
            vacancyPct: unformat($('vacancyPct').value) / 100,
            annualMaintenance: unformat($('annualMaintenance').value),
        };

        return { ...commonParams, ...trackParams };
    }


    // --- Event Handlers & Setup ---
    function handleAddTrack() {
        const newTrack = {
            id: Date.now(),
            name: `מסלול ${tracks.length + 1}`,
            pricingMode: 'deposit'
        };
        tracks.push(newTrack);
        renderTrackCard(newTrack);
    }
    
    function handleCalculate() {
        const trackNames = Array.from(document.querySelectorAll('input[id^="trackName"]')).map(input => input.value);
        if (trackNames.length === 0) {
            alert('יש להוסיף לפחות מסלול אחד להשוואה.');
            return;
        }

        simulationResults = trackNames.map(name => {
            const params = readAllInputsForTrack(name);
            return simulate(params);
        });
        
        setupYearSlider();
        renderResults();
    }
    
    function setupYearSlider() {
        const slider = $('yearSlider');
        const datalist = $('yearTicks');
        const maxYears = Math.max(0.5, unformat($('maxYears').value) || 15, ...simulationResults.map(r => Math.ceil(r.summary.totalMonths / 12)));
        
        slider.min = 0.5;
        slider.step = 0.5;
        slider.max = maxYears;
        slider.value = maxYears;
        $('sliderMinLabel').textContent = 'חצי שנה';
        $('sliderMaxLabel').textContent = `שנה ${maxYears}`;

        datalist.innerHTML = '';
        for (let i = 1; i <= Math.floor(maxYears); i++) {
            const option = document.createElement('option');
            option.value = i;
            datalist.appendChild(option);
        }

        slider.oninput = renderResults;
    }

    // --- Utilities ---
    const formatNumber = (v) => {
        if (v === '' || v === null || v === undefined) return '';
        const clean = v.toString().replace(/[^0-9.]/g, '');
        if (clean === '') return '';
        const parts = clean.split('.');
        const integerPart = new Intl.NumberFormat('he-IL').format(Number(parts[0]));
        return parts.length > 1 ? `${integerPart}.${parts[1]}` : integerPart;
    };
    
    function setupNumberFormattingForContainer(container) {
        container.querySelectorAll('input[type="text"][inputmode="decimal"]').forEach(input => {
            input.value = formatNumber(input.value);
            input.addEventListener('input', (e) => {
                const { target } = e;
                const originalValue = target.value;
                const cursorPos = target.selectionStart;
                const digitsToRight = (originalValue.substring(cursorPos).match(/\d/g) || []).length;
                
                const formattedValue = formatNumber(originalValue);
                if (originalValue === formattedValue) return;
                target.value = formattedValue;
                
                let newCursorPos = formattedValue.length;
                if (digitsToRight > 0) {
                    let digitsCounted = 0;
                    for (let i = formattedValue.length - 1; i >= 0; i--) {
                        if (/\d/.test(formattedValue[i])) digitsCounted++;
                        if (digitsCounted === digitsToRight) {
                            newCursorPos = i;
                            break;
                        }
                    }
                }
                target.setSelectionRange(newCursorPos, newCursorPos);
            });
        });
    }

    function updateTradeoffCalculation(trackId) {
        const tradeoffInput = $(`tradeoffAmount_${trackId}`);
        const maintenanceInput = $(`baseWithDeposit_${trackId}`);
        const depositInput = $(`depositAmount_${trackId}`);
        
        const baseMaintenance = unformat(maintenanceInput.dataset.baseValue);
        const baseDeposit = unformat(depositInput.dataset.baseValue);
        const tradeoffAmount = unformat(tradeoffInput.value);
        
        const newMaintenance = baseMaintenance + tradeoffAmount;
        const newDeposit = baseDeposit - (tradeoffAmount / 1000) * 100000;
        
        maintenanceInput.value = formatNumber(Math.max(0, newMaintenance));
        depositInput.value = formatNumber(Math.max(0, newDeposit));
    }


    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => { 
        // Initial setup for common inputs
        setupNumberFormattingForContainer(document.body);
        
        $('isNursing').addEventListener('change', (e) => {
            $('nursingFieldsRow').style.display = e.target.checked ? 'grid' : 'none';
        });

        $('assetScenarioSelect').addEventListener('change', (e) => {
            const scenario = e.target.value;
            $('sellBlock').style.display = scenario === 'sell' ? 'block' : 'none';
            $('rentBlock').style.display = scenario === 'rent' ? 'block' : 'none';
        });

        // Track management
        $('addTrackBtn').addEventListener('click', handleAddTrack);
        $('tracksContainer').addEventListener('click', (e) => {
            if (e.target.dataset.removeTrackId) {
                const trackId = e.target.dataset.removeTrackId;
                tracks = tracks.filter(t => t.id != trackId);
                document.querySelector(`.track-card[data-track-id='${trackId}']`).remove();
            } else if (e.target.classList.contains('stepper-btn')) {
                const { trackId, stepDir } = e.target.dataset;
                const tradeoffInput = $(`tradeoffAmount_${trackId}`);
                const currentVal = unformat(tradeoffInput.value);
                const newVal = currentVal + (stepDir === 'up' ? 500 : -500);
                tradeoffInput.value = formatNumber(newVal);
                updateTradeoffCalculation(trackId);
            }
        });

        $('tracksContainer').addEventListener('change', (e) => {
            if (e.target.id.startsWith('pricingMode_')) {
                const trackId = e.target.id.split('_')[1];
                updateTrackBody(trackId);
            }
        });

        $('tracksContainer').addEventListener('input', (e) => {
            const trackId = e.target.dataset.trackId;
            if (!trackId) return;

            const isMaintenance = e.target.id.startsWith('baseWithDeposit_');
            const isDeposit = e.target.id.startsWith('depositAmount_');
            
            if (isMaintenance || isDeposit) {
                // User is manually editing a base value, so reset the tradeoff.
                e.target.dataset.baseValue = unformat(e.target.value);
                const tradeoffInput = $(`tradeoffAmount_${trackId}`);
                if (tradeoffInput.value !== '0') {
                    tradeoffInput.value = '0';
                    // If we reset maintenance, we need to update the deposit base value based on the other field.
                    if (isMaintenance) {
                        const depositInput = $(`depositAmount_${trackId}`);
                        depositInput.dataset.baseValue = unformat(depositInput.value);
                    } else { // if we reset deposit, update maintenance base
                        const maintenanceInput = $(`baseWithDeposit_${trackId}`);
                        maintenanceInput.dataset.baseValue = unformat(maintenanceInput.value);
                    }
                }
            }
        });

        // Calculation
        $('calculateBtn').addEventListener('click', handleCalculate);
        
        // Add one track by default
        handleAddTrack();
    });
  </script>
</body>
</html>